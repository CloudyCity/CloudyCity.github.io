{"title":"Laravel-Websockets组件实践","uid":"fec643b4103ddf5fb791d3e0f56f5c2e","slug":"Laravel-Websockets组件实践","date":"2021-04-30T10:11:34.000Z","updated":"2021-06-21T10:35:56.784Z","comments":true,"path":"api/articles/Laravel-Websockets组件实践.json","cover":"https://laravelnews.imgix.net/images/laravel-websockets.png?ixlib=php-3.3.0","content":"<p>给Laravel项目搭建Websocket服务时，不想用<code>pusher</code>这种在线服务? 觉得用<code>laravel-echo-server</code>监听事件不方便? 不想用<code>swoole</code>自己实现? 那你可以考虑<a href=\"https://laravel.com/docs/8.x/broadcasting#pusher-compatible-laravel-websockets\">Laravel官方</a>推荐的<code>laravel-websockets</code>组件。</p>\n<span id=\"more\"></span>\n\n<p>该组件有以下优点:</p>\n<ul>\n<li>免费</li>\n<li>使用Pusher驱动</li>\n<li>方便继承扩展，实现流程控制</li>\n</ul>\n<h3 id=\"引入\"><a href=\"#引入\" class=\"headerlink\" title=\"引入\"></a>引入</h3><pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\"><span class=\"token function\">composer</span> require <span class=\"token string\">\"beyondcode/laravel-websockets:^2.0\"</span>\n<span class=\"token function\">composer</span> require digitaltolk/multiple-broadcaster<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n\n<div class=\"custom-quote tip\">\n<span class=\"custom-quote-svg\"><svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"\" xmlns=\"http://www.w3.org/2000/svg\" data-reactroot=\"\">\n<path fill=\"\" d=\"M20.86 14.13C20 14.7 19.56 15.74 19.77 16.76C20.13 18.55 18.55 20.13 16.76 19.77C15.74 19.57 14.7 20 14.13 20.86C13.12 22.38 10.89 22.38 9.88 20.86C9.3 20 8.26 19.56 7.24 19.77C5.45 20.13 3.87 18.55 4.23 16.76C4.43 15.74 4 14.7 3.14 14.13C1.62 13.12 1.62 10.89 3.14 9.88C4 9.3 4.44 8.26 4.23 7.24C3.87 5.45 5.45 3.87 7.24 4.23C8.26 4.44 9.3 4 9.87 3.14C10.88 1.62 13.11 1.62 14.12 3.14C14.7 4 15.74 4.44 16.76 4.23C18.55 3.87 20.13 5.45 19.77 7.24C19.56 8.26 20 9.3 20.86 9.87C22.38 10.88 22.38 13.12 20.86 14.13Z\" undefined=\"1\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M12.01 15C12.01 14.5 12.01 14.5 12.01 14.5C12.04 13.75 13 13.46 14.04 12.2C14.41 11.74 14.69 11.41 14.86 10.85C15.15 9.95 14.92 9.18 14.86 9.02C14.8 8.79 14.52 8 13.72 7.46C13.06 7.02 12.42 7 12.14 7C11.9 7 11.36 7 10.78 7.3C10.28 7.56 9.98 7.9 9.83 8.1C9.24 8.82 9.06 9.63 9 10.06\"></path>\n<path stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M11.99 18H12.01\"></path>\n</svg></span>\n<p class=\"custom-quote-title\">提示</p>\n<p>1.x版本存在一些问题，扩展的时候有一些麻烦，组件作者也是推荐2.x版本</p>\n</div>\n<h3 id=\"安装\"><a href=\"#安装\" class=\"headerlink\" title=\"安装\"></a>安装</h3><pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">php artisan vendor:publish --provider<span class=\"token operator\">=</span><span class=\"token string\">\"BeyondCode\\LaravelWebSockets\\WebSocketsServiceProvider\"</span> --tag<span class=\"token operator\">=</span><span class=\"token string\">\"migrations\"</span>\nphp artisan migrate\nphp artisan vendor:publish --provider<span class=\"token operator\">=</span><span class=\"token string\">\"BeyondCode\\LaravelWebSockets\\WebSocketsServiceProvider\"</span> --tag<span class=\"token operator\">=</span><span class=\"token string\">\"config\"</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre>\n\n<h3 id=\"自定义\"><a href=\"#自定义\" class=\"headerlink\" title=\"自定义\"></a>自定义</h3><h4 id=\"需求\"><a href=\"#需求\" class=\"headerlink\" title=\"需求\"></a>需求</h4><ul>\n<li>后台用户和普通用户的服务互不干扰</li>\n<li>监听普通用户的行为</li>\n</ul>\n<h4 id=\"事件\"><a href=\"#事件\" class=\"headerlink\" title=\"事件\"></a>事件</h4><p>创建几个基础事件。</p>\n<ul>\n<li><code>UserEnterChannel</code>: 用户订阅channel</li>\n<li><code>UserExitChannel</code>: 用户取消订阅channel</li>\n<li><code>UserAppBackground</code>: 用户APP切换至后台</li>\n<li><code>UserAppForeground</code>: 用户APP切换至前台台</li>\n</ul>\n<p>继承<code>BeyondCode\\LaravelWebSockets\\Server\\WebSocketHandler</code>，监听客户端消息，触发<code>UserAppBackground</code>、<code>UserAppForeground</code>事件。</p>\n<div class=\"custom-quote warning\">\n<span class=\"custom-quote-svg\"><svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"\" xmlns=\"http://www.w3.org/2000/svg\" data-reactroot=\"\">\n<path fill=\"\" d=\"M20.86 14.13C20 14.7 19.56 15.74 19.77 16.76C20.13 18.55 18.55 20.13 16.76 19.77C15.74 19.57 14.7 20 14.13 20.86C13.12 22.38 10.89 22.38 9.88 20.86C9.3 20 8.26 19.56 7.24 19.77C5.45 20.13 3.87 18.55 4.23 16.76C4.43 15.74 4 14.7 3.14 14.13C1.62 13.12 1.62 10.89 3.14 9.88C4 9.3 4.44 8.26 4.23 7.24C3.87 5.45 5.45 3.87 7.24 4.23C8.26 4.44 9.3 4 9.87 3.14C10.88 1.62 13.11 1.62 14.12 3.14C14.7 4 15.74 4.44 16.76 4.23C18.55 3.87 20.13 5.45 19.77 7.24C19.56 8.26 20 9.3 20.86 9.87C22.38 10.88 22.38 13.12 20.86 14.13Z\" undefined=\"1\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M12 8V13\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M12 15.99V16.01\"></path>\n</svg>\n</span>\n<p class=\"custom-quote-title\">注意</p>\n<p>注意WebSocketHandler@onOpen($connection)中可以获取的信息非常有限，无法识别出用户。组件自带的事件NewConnection和ConnectionClosed也只有appId和socketId。</p>\n</div>\n<details class=\"custom-details\">\n<summary>Click to see more</summary>\n<p><pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\"><span class=\"token php language-php\"><span class=\"token delimiter important\">&lt;?php</span>\n\n<span class=\"token keyword\">namespace</span> <span class=\"token package\">App<span class=\"token punctuation\">\\</span>Services<span class=\"token punctuation\">\\</span>WebSockets<span class=\"token punctuation\">\\</span>Server</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">use</span> <span class=\"token package\">App<span class=\"token punctuation\">\\</span>Events<span class=\"token punctuation\">\\</span>UserAppBackground</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">use</span> <span class=\"token package\">App<span class=\"token punctuation\">\\</span>Events<span class=\"token punctuation\">\\</span>UserAppForeground</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">use</span> <span class=\"token package\">App<span class=\"token punctuation\">\\</span>Services<span class=\"token punctuation\">\\</span>WebSockets<span class=\"token punctuation\">\\</span>ChannelManagers<span class=\"token punctuation\">\\</span>LocalChannelManager</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">use</span> <span class=\"token package\">BeyondCode<span class=\"token punctuation\">\\</span>LaravelWebSockets<span class=\"token punctuation\">\\</span>Server<span class=\"token punctuation\">\\</span>WebSocketHandler</span> <span class=\"token keyword\">as</span> BaseWebSocketHandler<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">use</span> <span class=\"token package\">Ratchet<span class=\"token punctuation\">\\</span>ConnectionInterface</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">use</span> <span class=\"token package\">Exception</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">use</span> <span class=\"token package\">Ratchet<span class=\"token punctuation\">\\</span>RFC6455<span class=\"token punctuation\">\\</span>Messaging<span class=\"token punctuation\">\\</span>MessageInterface</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">/**\n * Class Handler\n * @package App\\WebSockets\n * @link\n */</span>\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">WebSocketHandler</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">BaseWebSocketHandler</span>\n<span class=\"token punctuation\">&#123;</span>\n    <span class=\"token comment\">/**\n     * The channel manager.\n     *\n     * @var LocalChannelManager\n     */</span>\n    <span class=\"token keyword\">protected</span> <span class=\"token variable\">$channelManager</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">/**\n     * Handle the socket opening.\n     *\n     * @param \\Ratchet\\ConnectionInterface $connection\n     * @return void\n     * @throws \\Exception\n     */</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">function</span> <span class=\"token function\">onOpen</span><span class=\"token punctuation\">(</span><span class=\"token class-name type-declaration\">ConnectionInterface</span> <span class=\"token variable\">$connection</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">&#123;</span>\n        <span class=\"token keyword static-context\">parent</span><span class=\"token operator\">::</span><span class=\"token function\">onOpen</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$connection</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">&#125;</span>\n\n    <span class=\"token comment\">/**\n     * Handle the websocket close.\n     *\n     * @param  \\Ratchet\\ConnectionInterface  $connection\n     * @return void\n     */</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">function</span> <span class=\"token function\">onClose</span><span class=\"token punctuation\">(</span><span class=\"token class-name type-declaration\">ConnectionInterface</span> <span class=\"token variable\">$connection</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">&#123;</span>\n        <span class=\"token keyword static-context\">parent</span><span class=\"token operator\">::</span><span class=\"token function\">onClose</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$connection</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">&#125;</span>\n\n    <span class=\"token comment\">/**\n     * Handle the websocket errors.\n     *\n     * @param \\Ratchet\\ConnectionInterface $connection\n     * @param Exception $exception\n     * @return void\n     */</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">function</span> <span class=\"token function\">onError</span><span class=\"token punctuation\">(</span><span class=\"token class-name type-declaration\">ConnectionInterface</span> <span class=\"token variable\">$connection</span><span class=\"token punctuation\">,</span> <span class=\"token class-name type-declaration\">Exception</span> <span class=\"token variable\">$exception</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">&#123;</span>\n        <span class=\"token keyword static-context\">parent</span><span class=\"token operator\">::</span><span class=\"token function\">onError</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$connection</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$exception</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">&#125;</span>\n\n    <span class=\"token comment\">/**\n     * Handle the incoming message.\n     *\n     * @param  \\Ratchet\\ConnectionInterface  $connection\n     * @param  \\Ratchet\\RFC6455\\Messaging\\MessageInterface  $message\n     * @return void\n     */</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">function</span> <span class=\"token function\">onMessage</span><span class=\"token punctuation\">(</span><span class=\"token class-name type-declaration\">ConnectionInterface</span> <span class=\"token variable\">$connection</span><span class=\"token punctuation\">,</span> <span class=\"token class-name type-declaration\">MessageInterface</span> <span class=\"token variable\">$message</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">&#123;</span>\n        <span class=\"token variable\">$payload</span> <span class=\"token operator\">=</span> <span class=\"token function\">json_decode</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$message</span><span class=\"token operator\">-></span><span class=\"token function\">getPayload</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token variable\">$payload</span><span class=\"token operator\">-></span><span class=\"token property\">event</span> <span class=\"token operator\">==</span> <span class=\"token string single-quoted-string\">'client-app.background'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n            <span class=\"token variable\">$user</span> <span class=\"token operator\">=</span> <span class=\"token function\">getUserByChannel</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$payload</span><span class=\"token operator\">-></span><span class=\"token property\">channel</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token class-name static-context\">UserAppBackground</span><span class=\"token operator\">::</span><span class=\"token function\">dispatch</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$user</span><span class=\"token operator\">-></span><span class=\"token property\">id</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$user</span><span class=\"token operator\">-></span><span class=\"token property\">gid</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">&#125;</span> <span class=\"token keyword\">elseif</span> <span class=\"token punctuation\">(</span><span class=\"token variable\">$payload</span><span class=\"token operator\">-></span><span class=\"token property\">event</span> <span class=\"token operator\">==</span> <span class=\"token string single-quoted-string\">'client-app.foreground'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n            <span class=\"token variable\">$user</span> <span class=\"token operator\">=</span> <span class=\"token function\">getUserByChannel</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$payload</span><span class=\"token operator\">-></span><span class=\"token property\">channel</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token class-name static-context\">UserAppForeground</span><span class=\"token operator\">::</span><span class=\"token function\">dispatch</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$user</span><span class=\"token operator\">-></span><span class=\"token property\">id</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$user</span><span class=\"token operator\">-></span><span class=\"token property\">gid</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">&#125;</span>\n\n        <span class=\"token keyword static-context\">parent</span><span class=\"token operator\">::</span><span class=\"token function\">onMessage</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$connection</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$message</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">&#125;</span>\n<span class=\"token punctuation\">&#125;</span></span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n</p>\n</details>\n<h4 id=\"频道\"><a href=\"#频道\" class=\"headerlink\" title=\"频道\"></a>频道</h4><p>主要改写<code>PrivateChanel</code>，触发<code>UserEnterChannel</code>和<code>UserExitChannel</code>事件。</p>\n<details class=\"custom-details\">\n<summary>Click to see more</summary>\n<p><pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\"><span class=\"token php language-php\"><span class=\"token delimiter important\">&lt;?php</span>\n\n<span class=\"token keyword\">namespace</span> <span class=\"token package\">App<span class=\"token punctuation\">\\</span>Services<span class=\"token punctuation\">\\</span>WebSockets<span class=\"token punctuation\">\\</span>Channels</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">use</span> <span class=\"token package\">App<span class=\"token punctuation\">\\</span>Events<span class=\"token punctuation\">\\</span>UserEnterChannel</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">use</span> <span class=\"token package\">App<span class=\"token punctuation\">\\</span>Events<span class=\"token punctuation\">\\</span>UserExitChannel</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">use</span> <span class=\"token package\">App<span class=\"token punctuation\">\\</span>Services<span class=\"token punctuation\">\\</span>WebSockets<span class=\"token punctuation\">\\</span>ChannelManagers<span class=\"token punctuation\">\\</span>LocalChannelManager</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">use</span> <span class=\"token package\">BeyondCode<span class=\"token punctuation\">\\</span>LaravelWebSockets<span class=\"token punctuation\">\\</span>Channels<span class=\"token punctuation\">\\</span>PrivateChannel</span> <span class=\"token keyword\">as</span> BasePrivateChannel<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">use</span> <span class=\"token package\">BeyondCode<span class=\"token punctuation\">\\</span>LaravelWebSockets<span class=\"token punctuation\">\\</span>DashboardLogger</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">use</span> <span class=\"token package\">BeyondCode<span class=\"token punctuation\">\\</span>LaravelWebSockets<span class=\"token punctuation\">\\</span>Events<span class=\"token punctuation\">\\</span>SubscribedToChannel</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">use</span> <span class=\"token package\">BeyondCode<span class=\"token punctuation\">\\</span>LaravelWebSockets<span class=\"token punctuation\">\\</span>Events<span class=\"token punctuation\">\\</span>UnsubscribedFromChannel</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">use</span> <span class=\"token package\">BeyondCode<span class=\"token punctuation\">\\</span>LaravelWebSockets<span class=\"token punctuation\">\\</span>Server<span class=\"token punctuation\">\\</span>Exceptions<span class=\"token punctuation\">\\</span>InvalidSignature</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">use</span> <span class=\"token package\">Ratchet<span class=\"token punctuation\">\\</span>ConnectionInterface</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">use</span> <span class=\"token package\">stdClass</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">PrivateChannel</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">BasePrivateChannel</span>\n<span class=\"token punctuation\">&#123;</span>\n    <span class=\"token comment\">/**\n     * @var LocalChannelManager\n     */</span>\n    <span class=\"token keyword\">protected</span> <span class=\"token variable\">$channelManager</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">/**\n     * Subscribe to the channel.\n     *\n     * @see    https://pusher.com/docs/pusher_protocol#presence-channel-events\n     * @param  \\Ratchet\\ConnectionInterface  $connection\n     * @param  \\stdClass  $payload\n     * @return bool\n     * @throws InvalidSignature\n     */</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">function</span> <span class=\"token function\">subscribe</span><span class=\"token punctuation\">(</span><span class=\"token class-name type-declaration\">ConnectionInterface</span> <span class=\"token variable\">$connection</span><span class=\"token punctuation\">,</span> <span class=\"token class-name type-declaration\">stdClass</span> <span class=\"token variable\">$payload</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span> <span class=\"token keyword return-type\">bool</span>\n    <span class=\"token punctuation\">&#123;</span>\n        <span class=\"token variable\">$this</span><span class=\"token operator\">-></span><span class=\"token function\">verifySignature</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$connection</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$payload</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token comment\">// 针对特殊频道</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">isUserChannel</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$payload</span><span class=\"token operator\">-></span><span class=\"token property\">channel</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n            <span class=\"token comment\">// 识别用户</span>\n            <span class=\"token variable\">$user</span> <span class=\"token operator\">=</span> <span class=\"token function\">getUserByChannel</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$payload</span><span class=\"token operator\">-></span><span class=\"token property\">channel</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n            <span class=\"token comment\">// 触发事件</span>\n            <span class=\"token class-name static-context\">UserEnterChannel</span><span class=\"token operator\">::</span><span class=\"token function\">dispatch</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$user</span><span class=\"token operator\">-></span><span class=\"token property\">id</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$user</span><span class=\"token operator\">-></span><span class=\"token property\">gid</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n            <span class=\"token comment\">// 保存在成员数组中</span>\n            <span class=\"token variable\">$this</span><span class=\"token operator\">-></span><span class=\"token property\">channelManager</span>\n                <span class=\"token operator\">-></span><span class=\"token function\">userJoinedPrivateChannel</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$connection</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$user</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$this</span><span class=\"token operator\">-></span><span class=\"token function\">getName</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$payload</span><span class=\"token punctuation\">)</span>\n                <span class=\"token operator\">-></span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token variable\">$users</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">use</span> <span class=\"token punctuation\">(</span><span class=\"token variable\">$connection</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n                    <span class=\"token variable\">$connection</span><span class=\"token operator\">-></span><span class=\"token function\">send</span><span class=\"token punctuation\">(</span><span class=\"token function\">json_encode</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>\n                        <span class=\"token string single-quoted-string\">'event'</span> <span class=\"token operator\">=></span> <span class=\"token string single-quoted-string\">'pusher_internal:subscription_succeeded'</span><span class=\"token punctuation\">,</span>\n                        <span class=\"token string single-quoted-string\">'channel'</span> <span class=\"token operator\">=></span> <span class=\"token variable\">$this</span><span class=\"token operator\">-></span><span class=\"token function\">getName</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n                        <span class=\"token string single-quoted-string\">'data'</span> <span class=\"token operator\">=></span> <span class=\"token string single-quoted-string\">'[]'</span><span class=\"token punctuation\">,</span>\n                    <span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span>\n                <span class=\"token operator\">-></span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">use</span> <span class=\"token punctuation\">(</span><span class=\"token variable\">$connection</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$user</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$payload</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n                    <span class=\"token comment\">// The `pusher_internal:member_added` event is triggered when a user joins a channel.</span>\n                    <span class=\"token comment\">// It's quite possible that a user can have multiple connections to the same channel</span>\n                    <span class=\"token comment\">// (for example by having multiple browser tabs open)</span>\n                    <span class=\"token comment\">// and in this case the events will only be triggered when the first tab is opened.</span>\n                    <span class=\"token variable\">$this</span><span class=\"token operator\">-></span><span class=\"token property\">channelManager</span>\n                        <span class=\"token operator\">-></span><span class=\"token function\">getMemberSockets</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$user</span><span class=\"token operator\">-></span><span class=\"token property\">id</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$connection</span><span class=\"token operator\">-></span><span class=\"token property\">app</span><span class=\"token operator\">-></span><span class=\"token property\">id</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$this</span><span class=\"token operator\">-></span><span class=\"token function\">getName</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n                        <span class=\"token operator\">-></span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token variable\">$sockets</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">use</span> <span class=\"token punctuation\">(</span><span class=\"token variable\">$payload</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$connection</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$user</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n                            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">count</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$sockets</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">===</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n                                <span class=\"token variable\">$memberAddedPayload</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span>\n                                    <span class=\"token string single-quoted-string\">'event'</span> <span class=\"token operator\">=></span> <span class=\"token string single-quoted-string\">'pusher_internal:member_added'</span><span class=\"token punctuation\">,</span>\n                                    <span class=\"token string single-quoted-string\">'channel'</span> <span class=\"token operator\">=></span> <span class=\"token variable\">$this</span><span class=\"token operator\">-></span><span class=\"token function\">getName</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n                                    <span class=\"token string single-quoted-string\">'data'</span> <span class=\"token operator\">=></span> <span class=\"token variable\">$payload</span><span class=\"token operator\">-></span><span class=\"token property\">channel_data</span><span class=\"token punctuation\">,</span>\n                                <span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n\n                                <span class=\"token variable\">$this</span><span class=\"token operator\">-></span><span class=\"token function\">broadcastToEveryoneExcept</span><span class=\"token punctuation\">(</span>\n                                    <span class=\"token punctuation\">(</span><span class=\"token keyword type-casting\">object</span><span class=\"token punctuation\">)</span> <span class=\"token variable\">$memberAddedPayload</span><span class=\"token punctuation\">,</span>\n                                    <span class=\"token variable\">$connection</span><span class=\"token operator\">-></span><span class=\"token property\">socketId</span><span class=\"token punctuation\">,</span>\n                                    <span class=\"token variable\">$connection</span><span class=\"token operator\">-></span><span class=\"token property\">app</span><span class=\"token operator\">-></span><span class=\"token property\">id</span>\n                                <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n                                <span class=\"token class-name static-context\">SubscribedToChannel</span><span class=\"token operator\">::</span><span class=\"token function\">dispatch</span><span class=\"token punctuation\">(</span>\n                                    <span class=\"token variable\">$connection</span><span class=\"token operator\">-></span><span class=\"token property\">app</span><span class=\"token operator\">-></span><span class=\"token property\">id</span><span class=\"token punctuation\">,</span>\n                                    <span class=\"token variable\">$connection</span><span class=\"token operator\">-></span><span class=\"token property\">socketId</span><span class=\"token punctuation\">,</span>\n                                    <span class=\"token variable\">$this</span><span class=\"token operator\">-></span><span class=\"token function\">getName</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n                                    <span class=\"token variable\">$user</span>\n                                <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                            <span class=\"token punctuation\">&#125;</span>\n\n                            <span class=\"token class-name static-context\">DashboardLogger</span><span class=\"token operator\">::</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$connection</span><span class=\"token operator\">-></span><span class=\"token property\">app</span><span class=\"token operator\">-></span><span class=\"token property\">id</span><span class=\"token punctuation\">,</span> <span class=\"token class-name static-context\">DashboardLogger</span><span class=\"token operator\">::</span><span class=\"token constant\">TYPE_SUBSCRIBED</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span>\n                                <span class=\"token string single-quoted-string\">'socketId'</span> <span class=\"token operator\">=></span> <span class=\"token variable\">$connection</span><span class=\"token operator\">-></span><span class=\"token property\">socketId</span><span class=\"token punctuation\">,</span>\n                                <span class=\"token string single-quoted-string\">'channel'</span> <span class=\"token operator\">=></span> <span class=\"token variable\">$this</span><span class=\"token operator\">-></span><span class=\"token function\">getName</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n                                <span class=\"token string single-quoted-string\">'duplicate-connection'</span> <span class=\"token operator\">=></span> <span class=\"token function\">count</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$sockets</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">></span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span>\n                            <span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                        <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">&#125;</span>\n\n        <span class=\"token keyword\">return</span> <span class=\"token keyword static-context\">parent</span><span class=\"token operator\">::</span><span class=\"token function\">subscribe</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$connection</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$payload</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">&#125;</span>\n\n    <span class=\"token comment\">/**\n     * Unsubscribe connection from the channel.\n     *\n     * @param  \\Ratchet\\ConnectionInterface  $connection\n     * @return bool\n     */</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">function</span> <span class=\"token function\">unsubscribe</span><span class=\"token punctuation\">(</span><span class=\"token class-name type-declaration\">ConnectionInterface</span> <span class=\"token variable\">$connection</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span> <span class=\"token keyword return-type\">bool</span>\n    <span class=\"token punctuation\">&#123;</span>\n        <span class=\"token variable\">$truth</span> <span class=\"token operator\">=</span> <span class=\"token keyword static-context\">parent</span><span class=\"token operator\">::</span><span class=\"token function\">unsubscribe</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$connection</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token variable\">$this</span><span class=\"token operator\">-></span><span class=\"token property\">channelManager</span>\n            <span class=\"token operator\">-></span><span class=\"token function\">getChannelUser</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$connection</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$this</span><span class=\"token operator\">-></span><span class=\"token function\">getName</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n            <span class=\"token operator\">-></span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token variable\">$user</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n                <span class=\"token variable\">$user</span> <span class=\"token operator\">=</span> @<span class=\"token function\">json_decode</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$user</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n                <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token variable\">$user</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n                    <span class=\"token comment\">// 触发事件</span>\n                    <span class=\"token class-name static-context\">UserExitChannel</span><span class=\"token operator\">::</span><span class=\"token function\">dispatch</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$user</span><span class=\"token operator\">-></span><span class=\"token property\">id</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$user</span><span class=\"token operator\">-></span><span class=\"token property\">gid</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                <span class=\"token punctuation\">&#125;</span>\n\n                <span class=\"token keyword\">return</span> <span class=\"token variable\">$user</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span>\n            <span class=\"token operator\">-></span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token variable\">$user</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">use</span> <span class=\"token punctuation\">(</span><span class=\"token variable\">$connection</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n                <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span> <span class=\"token variable\">$user</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n                    <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span>\n                <span class=\"token punctuation\">&#125;</span>\n\n                <span class=\"token variable\">$this</span><span class=\"token operator\">-></span><span class=\"token property\">channelManager</span>\n                    <span class=\"token operator\">-></span><span class=\"token function\">userLeftPrivateChannel</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$connection</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$user</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$this</span><span class=\"token operator\">-></span><span class=\"token function\">getName</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n                    <span class=\"token operator\">-></span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">use</span> <span class=\"token punctuation\">(</span><span class=\"token variable\">$connection</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$user</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n                        <span class=\"token comment\">// The `pusher_internal:member_removed` is triggered when a user leaves a channel.</span>\n                        <span class=\"token comment\">// It's quite possible that a user can have multiple connections to the same channel</span>\n                        <span class=\"token comment\">// (for example by having multiple browser tabs open)</span>\n                        <span class=\"token comment\">// and in this case the events will only be triggered when the last one is closed.</span>\n                        <span class=\"token variable\">$this</span><span class=\"token operator\">-></span><span class=\"token property\">channelManager</span>\n                            <span class=\"token operator\">-></span><span class=\"token function\">getMemberSockets</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$user</span><span class=\"token operator\">-></span><span class=\"token property\">id</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$connection</span><span class=\"token operator\">-></span><span class=\"token property\">app</span><span class=\"token operator\">-></span><span class=\"token property\">id</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$this</span><span class=\"token operator\">-></span><span class=\"token function\">getName</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n                            <span class=\"token operator\">-></span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token variable\">$sockets</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">use</span> <span class=\"token punctuation\">(</span><span class=\"token variable\">$connection</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$user</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n                                <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">count</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$sockets</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">===</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n                                    <span class=\"token variable\">$memberRemovedPayload</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span>\n                                        <span class=\"token string single-quoted-string\">'event'</span> <span class=\"token operator\">=></span> <span class=\"token string single-quoted-string\">'pusher_internal:member_removed'</span><span class=\"token punctuation\">,</span>\n                                        <span class=\"token string single-quoted-string\">'channel'</span> <span class=\"token operator\">=></span> <span class=\"token variable\">$this</span><span class=\"token operator\">-></span><span class=\"token function\">getName</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n                                        <span class=\"token string single-quoted-string\">'data'</span> <span class=\"token operator\">=></span> <span class=\"token function\">json_encode</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>\n                                            <span class=\"token string single-quoted-string\">'uid'</span> <span class=\"token operator\">=></span> <span class=\"token variable\">$user</span><span class=\"token operator\">-></span><span class=\"token property\">id</span><span class=\"token punctuation\">,</span>\n                                        <span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n                                    <span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n\n                                    <span class=\"token variable\">$this</span><span class=\"token operator\">-></span><span class=\"token function\">broadcastToEveryoneExcept</span><span class=\"token punctuation\">(</span>\n                                        <span class=\"token punctuation\">(</span><span class=\"token keyword type-casting\">object</span><span class=\"token punctuation\">)</span> <span class=\"token variable\">$memberRemovedPayload</span><span class=\"token punctuation\">,</span>\n                                        <span class=\"token variable\">$connection</span><span class=\"token operator\">-></span><span class=\"token property\">socketId</span><span class=\"token punctuation\">,</span>\n                                        <span class=\"token variable\">$connection</span><span class=\"token operator\">-></span><span class=\"token property\">app</span><span class=\"token operator\">-></span><span class=\"token property\">id</span>\n                                    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n                                    <span class=\"token class-name static-context\">UnsubscribedFromChannel</span><span class=\"token operator\">::</span><span class=\"token function\">dispatch</span><span class=\"token punctuation\">(</span>\n                                        <span class=\"token variable\">$connection</span><span class=\"token operator\">-></span><span class=\"token property\">app</span><span class=\"token operator\">-></span><span class=\"token property\">id</span><span class=\"token punctuation\">,</span>\n                                        <span class=\"token variable\">$connection</span><span class=\"token operator\">-></span><span class=\"token property\">socketId</span><span class=\"token punctuation\">,</span>\n                                        <span class=\"token variable\">$this</span><span class=\"token operator\">-></span><span class=\"token function\">getName</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n                                        <span class=\"token variable\">$user</span>\n                                    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                                <span class=\"token punctuation\">&#125;</span>\n                            <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token keyword\">return</span> <span class=\"token variable\">$truth</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">&#125;</span>\n<span class=\"token punctuation\">&#125;</span></span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n</p>\n</details>\n<p>涉及的几个助手函数</p>\n<details class=\"custom-details\">\n<summary>Click to see more</summary>\n<p><pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\"><span class=\"token php language-php\"><span class=\"token delimiter important\">&lt;?php</span>\n\n<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token function\">function_exists</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'getUserChannelPrefix'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token comment\">/**\n     * 获取玩家的频道前缀\n     *\n     * @return string\n     */</span>\n    <span class=\"token keyword\">function</span> <span class=\"token function\">getUserChannelPrefix</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span> <span class=\"token keyword return-type\">string</span>\n    <span class=\"token punctuation\">&#123;</span>\n        <span class=\"token keyword\">return</span> <span class=\"token string single-quoted-string\">'private-user.'</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">&#125;</span>\n<span class=\"token punctuation\">&#125;</span>\n\n<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token function\">function_exists</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'isUserChannel'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token comment\">/**\n     * 判断是否为玩家用户的频道\n     *\n     * @param string $channel\n     * @return bool\n     */</span>\n    <span class=\"token keyword\">function</span> <span class=\"token function\">isUserChannel</span><span class=\"token punctuation\">(</span><span class=\"token keyword type-hint\">string</span> <span class=\"token variable\">$channel</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span> <span class=\"token keyword return-type\">bool</span>\n    <span class=\"token punctuation\">&#123;</span>\n        <span class=\"token variable\">$userChannelPrefix</span> <span class=\"token operator\">=</span> <span class=\"token function\">getUserChannelPrefix</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token variable\">$isUserChannel</span> <span class=\"token operator\">=</span> <span class=\"token class-name static-context\">Str</span><span class=\"token operator\">::</span><span class=\"token function\">startsWith</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$channel</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$userChannelPrefix</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token keyword\">return</span> <span class=\"token variable\">$isUserChannel</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">&#125;</span>\n<span class=\"token punctuation\">&#125;</span>\n\n<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token function\">function_exists</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'getIdsByChannel'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token comment\">/**\n     * 根据玩家频道名获取各ID\n     *\n     * @param string $channel\n     * @return stdClass\n     */</span>\n    <span class=\"token keyword\">function</span> <span class=\"token function\">getUserByChannel</span><span class=\"token punctuation\">(</span><span class=\"token keyword type-hint\">string</span> <span class=\"token variable\">$channel</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span> <span class=\"token class-name return-type\">stdClass</span>\n    <span class=\"token punctuation\">&#123;</span>\n        <span class=\"token variable\">$userChannelPrefix</span> <span class=\"token operator\">=</span> <span class=\"token function\">getUserChannelPrefix</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token variable\">$idString</span> <span class=\"token operator\">=</span> <span class=\"token function\">str_replace</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$userChannelPrefix</span><span class=\"token punctuation\">,</span> <span class=\"token string single-quoted-string\">''</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$channel</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">list</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$uid</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$gid</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> <span class=\"token function\">explode</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'.'</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$idString</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token variable\">$user</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">stdClass</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token variable\">$user</span><span class=\"token operator\">-></span><span class=\"token property\">id</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$uid</span><span class=\"token punctuation\">;</span>\n        <span class=\"token variable\">$user</span><span class=\"token operator\">-></span><span class=\"token property\">gid</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$gid</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token keyword\">return</span> <span class=\"token variable\">$user</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">&#125;</span>\n<span class=\"token punctuation\">&#125;</span></span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n</p>\n</details>\n<p>继承<code>BeyondCode\\LaravelWebSockets\\ChannelManagers\\LocalChannelManager</code>，实现<code>userJoinedPrivateChannel</code>、<code>userLeftPrivateChannel</code>、<code>getChannelUser</code>三个方法，在<code>PrivateChannel</code>中使用。</p>\n<details class=\"custom-details\">\n<summary>Click to see more</summary>\n<p><pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\"><span class=\"token php language-php\"><span class=\"token delimiter important\">&lt;?php</span>\n\n<span class=\"token keyword\">namespace</span> <span class=\"token package\">App<span class=\"token punctuation\">\\</span>Services<span class=\"token punctuation\">\\</span>WebSockets<span class=\"token punctuation\">\\</span>ChannelManagers</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">use</span> <span class=\"token package\">App<span class=\"token punctuation\">\\</span>Services<span class=\"token punctuation\">\\</span>WebSockets<span class=\"token punctuation\">\\</span>Channels<span class=\"token punctuation\">\\</span>Channel</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">use</span> <span class=\"token package\">App<span class=\"token punctuation\">\\</span>Services<span class=\"token punctuation\">\\</span>WebSockets<span class=\"token punctuation\">\\</span>Channels<span class=\"token punctuation\">\\</span>PresenceChannel</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">use</span> <span class=\"token package\">App<span class=\"token punctuation\">\\</span>Services<span class=\"token punctuation\">\\</span>WebSockets<span class=\"token punctuation\">\\</span>Channels<span class=\"token punctuation\">\\</span>PrivateChannel</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">use</span> <span class=\"token package\">BeyondCode<span class=\"token punctuation\">\\</span>LaravelWebSockets<span class=\"token punctuation\">\\</span>ChannelManagers<span class=\"token punctuation\">\\</span>LocalChannelManager</span> <span class=\"token keyword\">as</span> BaseLocalChannelManager<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">use</span> <span class=\"token package\">BeyondCode<span class=\"token punctuation\">\\</span>LaravelWebSockets<span class=\"token punctuation\">\\</span>Helpers</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">use</span> <span class=\"token package\">Illuminate<span class=\"token punctuation\">\\</span>Support<span class=\"token punctuation\">\\</span>Str</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">use</span> <span class=\"token package\">Ratchet<span class=\"token punctuation\">\\</span>ConnectionInterface</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">use</span> <span class=\"token package\">stdClass</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">use</span> <span class=\"token package\">React<span class=\"token punctuation\">\\</span>Promise<span class=\"token punctuation\">\\</span>PromiseInterface</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">LocalChannelManager</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">BaseLocalChannelManager</span>\n<span class=\"token punctuation\">&#123;</span>\n    <span class=\"token comment\">/**\n     * The list of users that joined the presence channel or private channel.\n     *\n     * private channel: key => UserObject\n     * presence channel: key => [ socketId => UserObject ]\n     * @var array\n     */</span>\n    <span class=\"token keyword\">protected</span> <span class=\"token variable\">$users</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">/**\n     * The list of users by socket and their attached id.\n     *\n     * @var array\n     */</span>\n    <span class=\"token keyword\">protected</span> <span class=\"token variable\">$userSockets</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">/**\n     * Get the channel class by the channel name.\n     *\n     * @param  string  $channelName\n     * @return string\n     */</span>\n    <span class=\"token keyword\">protected</span> <span class=\"token keyword\">function</span> <span class=\"token function\">getChannelClassName</span><span class=\"token punctuation\">(</span><span class=\"token keyword type-hint\">string</span> <span class=\"token variable\">$channelName</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span> <span class=\"token keyword return-type\">string</span>\n    <span class=\"token punctuation\">&#123;</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token class-name static-context\">Str</span><span class=\"token operator\">::</span><span class=\"token function\">startsWith</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$channelName</span><span class=\"token punctuation\">,</span> <span class=\"token string single-quoted-string\">'private-'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n            <span class=\"token keyword\">return</span> <span class=\"token class-name static-context\">PrivateChannel</span><span class=\"token operator\">::</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">&#125;</span>\n\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token class-name static-context\">Str</span><span class=\"token operator\">::</span><span class=\"token function\">startsWith</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$channelName</span><span class=\"token punctuation\">,</span> <span class=\"token string single-quoted-string\">'presence-'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n            <span class=\"token keyword\">return</span> <span class=\"token class-name static-context\">PresenceChannel</span><span class=\"token operator\">::</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">&#125;</span>\n\n        <span class=\"token keyword\">return</span> <span class=\"token class-name static-context\">Channel</span><span class=\"token operator\">::</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">&#125;</span>\n\n    <span class=\"token comment\">/**\n     * Get a member from a private channel based on connection.\n     *\n     * @param  \\Ratchet\\ConnectionInterface  $connection\n     * @param  string  $channel\n     * @return \\React\\Promise\\PromiseInterface\n     */</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">function</span> <span class=\"token function\">getChannelUser</span><span class=\"token punctuation\">(</span><span class=\"token class-name type-declaration\">ConnectionInterface</span> <span class=\"token variable\">$connection</span><span class=\"token punctuation\">,</span> <span class=\"token keyword type-hint\">string</span> <span class=\"token variable\">$channel</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span> <span class=\"token class-name return-type\">PromiseInterface</span>\n    <span class=\"token punctuation\">&#123;</span>\n        <span class=\"token variable\">$user</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$this</span><span class=\"token operator\">-></span><span class=\"token property\">users</span><span class=\"token punctuation\">[</span><span class=\"token string double-quoted-string\">\"<span class=\"token interpolation\"><span class=\"token punctuation\">&#123;</span><span class=\"token variable\">$connection</span><span class=\"token operator\">-></span><span class=\"token property\">app</span><span class=\"token operator\">-></span><span class=\"token property\">id</span><span class=\"token punctuation\">&#125;</span></span>:<span class=\"token interpolation\"><span class=\"token punctuation\">&#123;</span><span class=\"token variable\">$channel</span><span class=\"token punctuation\">&#125;</span></span>\"</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">??</span> <span class=\"token constant\">null</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token keyword\">return</span> <span class=\"token class-name static-context\">Helpers</span><span class=\"token operator\">::</span><span class=\"token function\">createFulfilledPromise</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$user</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">&#125;</span>\n\n    <span class=\"token comment\">/**\n     * Handle the user when it joined a private channel.\n     *\n     * @param  \\Ratchet\\ConnectionInterface  $connection\n     * @param  stdClass  $user\n     * @param  string  $channel\n     * @param  stdClass  $payload\n     * @return PromiseInterface[bool]\n     */</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">function</span> <span class=\"token function\">userJoinedPrivateChannel</span><span class=\"token punctuation\">(</span><span class=\"token class-name type-declaration\">ConnectionInterface</span> <span class=\"token variable\">$connection</span><span class=\"token punctuation\">,</span> <span class=\"token class-name type-declaration\">stdClass</span> <span class=\"token variable\">$user</span><span class=\"token punctuation\">,</span> <span class=\"token keyword type-hint\">string</span> <span class=\"token variable\">$channel</span><span class=\"token punctuation\">,</span> <span class=\"token class-name type-declaration\">stdClass</span> <span class=\"token variable\">$payload</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span> <span class=\"token class-name return-type\">PromiseInterface</span>\n    <span class=\"token punctuation\">&#123;</span>\n        <span class=\"token variable\">$this</span><span class=\"token operator\">-></span><span class=\"token property\">users</span><span class=\"token punctuation\">[</span><span class=\"token string double-quoted-string\">\"<span class=\"token interpolation\"><span class=\"token punctuation\">&#123;</span><span class=\"token variable\">$connection</span><span class=\"token operator\">-></span><span class=\"token property\">app</span><span class=\"token operator\">-></span><span class=\"token property\">id</span><span class=\"token punctuation\">&#125;</span></span>:<span class=\"token interpolation\"><span class=\"token punctuation\">&#123;</span><span class=\"token variable\">$channel</span><span class=\"token punctuation\">&#125;</span></span>\"</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token function\">json_encode</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$user</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token variable\">$this</span><span class=\"token operator\">-></span><span class=\"token property\">userSockets</span><span class=\"token punctuation\">[</span><span class=\"token string double-quoted-string\">\"<span class=\"token interpolation\"><span class=\"token punctuation\">&#123;</span><span class=\"token variable\">$connection</span><span class=\"token operator\">-></span><span class=\"token property\">app</span><span class=\"token operator\">-></span><span class=\"token property\">id</span><span class=\"token punctuation\">&#125;</span></span>:<span class=\"token interpolation\"><span class=\"token punctuation\">&#123;</span><span class=\"token variable\">$channel</span><span class=\"token punctuation\">&#125;</span></span>:<span class=\"token interpolation\"><span class=\"token punctuation\">&#123;</span><span class=\"token variable\">$user</span><span class=\"token operator\">-></span><span class=\"token property\">id</span><span class=\"token punctuation\">&#125;</span></span>\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$connection</span><span class=\"token operator\">-></span><span class=\"token property\">socketId</span><span class=\"token punctuation\">;</span>\n        <span class=\"token function\">used</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$payload</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token keyword\">return</span> <span class=\"token class-name static-context\">Helpers</span><span class=\"token operator\">::</span><span class=\"token function\">createFulfilledPromise</span><span class=\"token punctuation\">(</span><span class=\"token constant boolean\">true</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">&#125;</span>\n\n    <span class=\"token comment\">/**\n     * Handle the user when it left a presence channel.\n     *\n     * @param  \\Ratchet\\ConnectionInterface  $connection\n     * @param  stdClass  $user\n     * @param  string  $channel\n     * @return PromiseInterface[bool]\n     */</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">function</span> <span class=\"token function\">userLeftPrivateChannel</span><span class=\"token punctuation\">(</span><span class=\"token class-name type-declaration\">ConnectionInterface</span> <span class=\"token variable\">$connection</span><span class=\"token punctuation\">,</span> <span class=\"token class-name type-declaration\">stdClass</span> <span class=\"token variable\">$user</span><span class=\"token punctuation\">,</span> <span class=\"token keyword type-hint\">string</span> <span class=\"token variable\">$channel</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span> <span class=\"token class-name return-type\">PromiseInterface</span>\n    <span class=\"token punctuation\">&#123;</span>\n        <span class=\"token keyword\">unset</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$this</span><span class=\"token operator\">-></span><span class=\"token property\">users</span><span class=\"token punctuation\">[</span><span class=\"token string double-quoted-string\">\"<span class=\"token interpolation\"><span class=\"token punctuation\">&#123;</span><span class=\"token variable\">$connection</span><span class=\"token operator\">-></span><span class=\"token property\">app</span><span class=\"token operator\">-></span><span class=\"token property\">id</span><span class=\"token punctuation\">&#125;</span></span>:<span class=\"token interpolation\"><span class=\"token punctuation\">&#123;</span><span class=\"token variable\">$channel</span><span class=\"token punctuation\">&#125;</span></span>\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token variable\">$deletableSocketKey</span> <span class=\"token operator\">=</span> <span class=\"token function\">array_search</span><span class=\"token punctuation\">(</span>\n            <span class=\"token variable\">$connection</span><span class=\"token operator\">-></span><span class=\"token property\">socketId</span><span class=\"token punctuation\">,</span>\n            <span class=\"token variable\">$this</span><span class=\"token operator\">-></span><span class=\"token property\">userSockets</span><span class=\"token punctuation\">[</span><span class=\"token string double-quoted-string\">\"<span class=\"token interpolation\"><span class=\"token punctuation\">&#123;</span><span class=\"token variable\">$connection</span><span class=\"token operator\">-></span><span class=\"token property\">app</span><span class=\"token operator\">-></span><span class=\"token property\">id</span><span class=\"token punctuation\">&#125;</span></span>:<span class=\"token interpolation\"><span class=\"token punctuation\">&#123;</span><span class=\"token variable\">$channel</span><span class=\"token punctuation\">&#125;</span></span>:<span class=\"token interpolation\"><span class=\"token punctuation\">&#123;</span><span class=\"token variable\">$user</span><span class=\"token operator\">-></span><span class=\"token property\">id</span><span class=\"token punctuation\">&#125;</span></span>\"</span><span class=\"token punctuation\">]</span>\n        <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token variable\">$deletableSocketKey</span> <span class=\"token operator\">!==</span> <span class=\"token constant boolean\">false</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n            <span class=\"token keyword\">unset</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$this</span><span class=\"token operator\">-></span><span class=\"token property\">userSockets</span><span class=\"token punctuation\">[</span><span class=\"token string double-quoted-string\">\"<span class=\"token interpolation\"><span class=\"token punctuation\">&#123;</span><span class=\"token variable\">$connection</span><span class=\"token operator\">-></span><span class=\"token property\">app</span><span class=\"token operator\">-></span><span class=\"token property\">id</span><span class=\"token punctuation\">&#125;</span></span>:<span class=\"token interpolation\"><span class=\"token punctuation\">&#123;</span><span class=\"token variable\">$channel</span><span class=\"token punctuation\">&#125;</span></span>:<span class=\"token interpolation\"><span class=\"token punctuation\">&#123;</span><span class=\"token variable\">$user</span><span class=\"token operator\">-></span><span class=\"token property\">id</span><span class=\"token punctuation\">&#125;</span></span>\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token variable\">$deletableSocketKey</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">count</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$this</span><span class=\"token operator\">-></span><span class=\"token property\">userSockets</span><span class=\"token punctuation\">[</span><span class=\"token string double-quoted-string\">\"<span class=\"token interpolation\"><span class=\"token punctuation\">&#123;</span><span class=\"token variable\">$connection</span><span class=\"token operator\">-></span><span class=\"token property\">app</span><span class=\"token operator\">-></span><span class=\"token property\">id</span><span class=\"token punctuation\">&#125;</span></span>:<span class=\"token interpolation\"><span class=\"token punctuation\">&#123;</span><span class=\"token variable\">$channel</span><span class=\"token punctuation\">&#125;</span></span>:<span class=\"token interpolation\"><span class=\"token punctuation\">&#123;</span><span class=\"token variable\">$user</span><span class=\"token operator\">-></span><span class=\"token property\">id</span><span class=\"token punctuation\">&#125;</span></span>\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">===</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n                <span class=\"token keyword\">unset</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$this</span><span class=\"token operator\">-></span><span class=\"token property\">userSockets</span><span class=\"token punctuation\">[</span><span class=\"token string double-quoted-string\">\"<span class=\"token interpolation\"><span class=\"token punctuation\">&#123;</span><span class=\"token variable\">$connection</span><span class=\"token operator\">-></span><span class=\"token property\">app</span><span class=\"token operator\">-></span><span class=\"token property\">id</span><span class=\"token punctuation\">&#125;</span></span>:<span class=\"token interpolation\"><span class=\"token punctuation\">&#123;</span><span class=\"token variable\">$channel</span><span class=\"token punctuation\">&#125;</span></span>:<span class=\"token interpolation\"><span class=\"token punctuation\">&#123;</span><span class=\"token variable\">$user</span><span class=\"token operator\">-></span><span class=\"token property\">id</span><span class=\"token punctuation\">&#125;</span></span>\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">&#125;</span>\n        <span class=\"token punctuation\">&#125;</span>\n\n        <span class=\"token keyword\">return</span> <span class=\"token class-name static-context\">Helpers</span><span class=\"token operator\">::</span><span class=\"token function\">createFulfilledPromise</span><span class=\"token punctuation\">(</span><span class=\"token constant boolean\">true</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">&#125;</span>\n<span class=\"token punctuation\">&#125;</span></span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n</p>\n</details>\n<h3 id=\"配置\"><a href=\"#配置\" class=\"headerlink\" title=\"配置\"></a>配置</h3><p>修改<strong>websockets.php</strong>，使用继承后的类，并配置多app。</p>\n<details class=\"custom-details\">\n<summary>Click to see more</summary>\n<p><pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\"><span class=\"token php language-php\"><span class=\"token delimiter important\">&lt;?php</span>\n\n<span class=\"token keyword\">return</span> <span class=\"token punctuation\">[</span>\n\n    <span class=\"token comment\">/*\n    |--------------------------------------------------------------------------\n    | Dashboard Settings\n    |--------------------------------------------------------------------------\n    |\n    | You can configure the dashboard settings from here.\n    |\n    */</span>\n\n    <span class=\"token string single-quoted-string\">'dashboard'</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">[</span>\n\n        <span class=\"token string single-quoted-string\">'port'</span> <span class=\"token operator\">=></span> <span class=\"token function\">env</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'LARAVEL_WEBSOCKETS_PORT'</span><span class=\"token punctuation\">,</span> <span class=\"token number\">6001</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n\n        <span class=\"token string single-quoted-string\">'domain'</span> <span class=\"token operator\">=></span> <span class=\"token function\">env</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'LARAVEL_WEBSOCKETS_DOMAIN'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n\n        <span class=\"token string single-quoted-string\">'path'</span> <span class=\"token operator\">=></span> <span class=\"token function\">env</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'LARAVEL_WEBSOCKETS_PATH'</span><span class=\"token punctuation\">,</span> <span class=\"token string single-quoted-string\">'websockets'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n\n        <span class=\"token string single-quoted-string\">'middleware'</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">[</span>\n            <span class=\"token string single-quoted-string\">'web'</span><span class=\"token punctuation\">,</span>\n            <span class=\"token class-name class-name-fully-qualified static-context\"><span class=\"token punctuation\">\\</span>BeyondCode<span class=\"token punctuation\">\\</span>LaravelWebSockets<span class=\"token punctuation\">\\</span>Dashboard<span class=\"token punctuation\">\\</span>Http<span class=\"token punctuation\">\\</span>Middleware<span class=\"token punctuation\">\\</span>Authorize</span><span class=\"token operator\">::</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">,</span>\n        <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n\n    <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n\n    <span class=\"token string single-quoted-string\">'managers'</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">[</span>\n\n        <span class=\"token comment\">/*\n        |--------------------------------------------------------------------------\n        | Application Manager\n        |--------------------------------------------------------------------------\n        |\n        | An Application manager determines how your websocket server allows\n        | the use of the TCP protocol based on, for example, a list of allowed\n        | applications.\n        | By default, it uses the defined array in the config file, but you can\n        | anytime implement the same interface as the class and add your own\n        | custom method to retrieve the apps.\n        |\n        */</span>\n\n        <span class=\"token string single-quoted-string\">'app'</span> <span class=\"token operator\">=></span> <span class=\"token class-name class-name-fully-qualified static-context\"><span class=\"token punctuation\">\\</span>BeyondCode<span class=\"token punctuation\">\\</span>LaravelWebSockets<span class=\"token punctuation\">\\</span>Apps<span class=\"token punctuation\">\\</span>ConfigAppManager</span><span class=\"token operator\">::</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">,</span>\n\n    <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n\n    <span class=\"token comment\">/*\n    |--------------------------------------------------------------------------\n    | Applications Repository\n    |--------------------------------------------------------------------------\n    |\n    | By default, the only allowed app is the one you define with\n    | your PUSHER_* variables from .env.\n    | You can configure to use multiple apps if you need to, or use\n    | a custom App Manager that will handle the apps from a database, per se.\n    |\n    | You can apply multiple settings, like the maximum capacity, enable\n    | client-to-client messages or statistics.\n    |\n    */</span>\n\n    <span class=\"token string single-quoted-string\">'apps'</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">[</span>\n        <span class=\"token punctuation\">[</span>\n            <span class=\"token string single-quoted-string\">'id'</span> <span class=\"token operator\">=></span> <span class=\"token string single-quoted-string\">'admin-app-id'</span><span class=\"token punctuation\">,</span>\n            <span class=\"token string single-quoted-string\">'name'</span> <span class=\"token operator\">=></span> <span class=\"token string single-quoted-string\">'ADMIN'</span><span class=\"token punctuation\">,</span>\n            <span class=\"token string single-quoted-string\">'host'</span> <span class=\"token operator\">=></span> <span class=\"token constant\">null</span><span class=\"token punctuation\">,</span>\n            <span class=\"token string single-quoted-string\">'key'</span> <span class=\"token operator\">=></span> <span class=\"token string single-quoted-string\">'admin-app-key'</span><span class=\"token punctuation\">,</span>\n            <span class=\"token string single-quoted-string\">'secret'</span> <span class=\"token operator\">=></span> <span class=\"token string single-quoted-string\">'admin-app-secret'</span><span class=\"token punctuation\">,</span>\n            <span class=\"token string single-quoted-string\">'path'</span> <span class=\"token operator\">=></span> <span class=\"token constant\">null</span><span class=\"token punctuation\">,</span>\n            <span class=\"token string single-quoted-string\">'capacity'</span> <span class=\"token operator\">=></span> <span class=\"token constant\">null</span><span class=\"token punctuation\">,</span>\n            <span class=\"token string single-quoted-string\">'enable_client_messages'</span> <span class=\"token operator\">=></span> <span class=\"token constant boolean\">true</span><span class=\"token punctuation\">,</span>\n            <span class=\"token string single-quoted-string\">'enable_statistics'</span> <span class=\"token operator\">=></span> <span class=\"token constant boolean\">true</span><span class=\"token punctuation\">,</span>\n            <span class=\"token string single-quoted-string\">'allowed_origins'</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">[</span>\n                <span class=\"token comment\">// env('LARAVEL_WEBSOCKETS_DOMAIN_ADMIN'),</span>\n            <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n        <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n        <span class=\"token punctuation\">[</span>\n            <span class=\"token string single-quoted-string\">'id'</span> <span class=\"token operator\">=></span> <span class=\"token string single-quoted-string\">'api-app-id'</span><span class=\"token punctuation\">,</span>\n            <span class=\"token string single-quoted-string\">'name'</span> <span class=\"token operator\">=></span> <span class=\"token string single-quoted-string\">'API'</span><span class=\"token punctuation\">,</span>\n            <span class=\"token string single-quoted-string\">'host'</span> <span class=\"token operator\">=></span> <span class=\"token constant\">null</span><span class=\"token punctuation\">,</span>\n            <span class=\"token string single-quoted-string\">'key'</span> <span class=\"token operator\">=></span> <span class=\"token string single-quoted-string\">'api-app-key'</span><span class=\"token punctuation\">,</span>\n            <span class=\"token string single-quoted-string\">'secret'</span> <span class=\"token operator\">=></span> <span class=\"token string single-quoted-string\">'api-app-secret'</span><span class=\"token punctuation\">,</span>\n            <span class=\"token string single-quoted-string\">'path'</span> <span class=\"token operator\">=></span> <span class=\"token constant\">null</span><span class=\"token punctuation\">,</span>\n            <span class=\"token string single-quoted-string\">'capacity'</span> <span class=\"token operator\">=></span> <span class=\"token constant\">null</span><span class=\"token punctuation\">,</span>\n            <span class=\"token string single-quoted-string\">'enable_client_messages'</span> <span class=\"token operator\">=></span> <span class=\"token constant boolean\">true</span><span class=\"token punctuation\">,</span>\n            <span class=\"token string single-quoted-string\">'enable_statistics'</span> <span class=\"token operator\">=></span> <span class=\"token constant boolean\">true</span><span class=\"token punctuation\">,</span>\n            <span class=\"token string single-quoted-string\">'allowed_origins'</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">[</span>\n                <span class=\"token comment\">// env('LARAVEL_WEBSOCKETS_DOMAIN'),</span>\n            <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n        <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n\n    <span class=\"token comment\">/*\n    |--------------------------------------------------------------------------\n    | Broadcasting Replication PubSub\n    |--------------------------------------------------------------------------\n    |\n    | You can enable replication to publish and subscribe to\n    | messages across the driver.\n    |\n    | By default, it is set to 'local', but you can configure it to use drivers\n    | like Redis to ensure connection between multiple instances of\n    | WebSocket servers. Just set the driver to 'redis' to enable the PubSub using Redis.\n    |\n    */</span>\n\n    <span class=\"token string single-quoted-string\">'replication'</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">[</span>\n\n        <span class=\"token string single-quoted-string\">'mode'</span> <span class=\"token operator\">=></span> <span class=\"token string single-quoted-string\">'local'</span><span class=\"token punctuation\">,</span>\n\n        <span class=\"token string single-quoted-string\">'modes'</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">[</span>\n\n            <span class=\"token comment\">/*\n            |--------------------------------------------------------------------------\n            | Local Replication\n            |--------------------------------------------------------------------------\n            |\n            | Local replication is actually a null replicator, meaning that it\n            | is the default behaviour of storing the connections into an array.\n            |\n            */</span>\n\n            <span class=\"token string single-quoted-string\">'local'</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">[</span>\n\n                <span class=\"token comment\">/*\n                |--------------------------------------------------------------------------\n                | Channel Manager\n                |--------------------------------------------------------------------------\n                |\n                | The channel manager is responsible for storing, tracking and retrieving\n                | the channels as long as their members and connections.\n                |\n                */</span>\n\n                <span class=\"token string single-quoted-string\">'channel_manager'</span> <span class=\"token operator\">=></span> <span class=\"token class-name class-name-fully-qualified static-context\"><span class=\"token punctuation\">\\</span>App<span class=\"token punctuation\">\\</span>Services<span class=\"token punctuation\">\\</span>WebSockets<span class=\"token punctuation\">\\</span>ChannelManagers<span class=\"token punctuation\">\\</span>LocalChannelManager</span><span class=\"token operator\">::</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">,</span>\n\n                <span class=\"token comment\">/*\n                |--------------------------------------------------------------------------\n                | Statistics Collector\n                |--------------------------------------------------------------------------\n                |\n                | The Statistics Collector will, by default, handle the incoming statistics,\n                | storing them until they will become dumped into another database, usually\n                | a MySQL database or a time-series database.\n                |\n                */</span>\n\n                <span class=\"token string single-quoted-string\">'collector'</span> <span class=\"token operator\">=></span> <span class=\"token class-name class-name-fully-qualified static-context\"><span class=\"token punctuation\">\\</span>BeyondCode<span class=\"token punctuation\">\\</span>LaravelWebSockets<span class=\"token punctuation\">\\</span>Statistics<span class=\"token punctuation\">\\</span>Collectors<span class=\"token punctuation\">\\</span>MemoryCollector</span><span class=\"token operator\">::</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">,</span>\n\n            <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n\n            <span class=\"token string single-quoted-string\">'redis'</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">[</span>\n\n                <span class=\"token string single-quoted-string\">'connection'</span> <span class=\"token operator\">=></span> <span class=\"token function\">env</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'WEBSOCKETS_REDIS_REPLICATION_CONNECTION'</span><span class=\"token punctuation\">,</span> <span class=\"token string single-quoted-string\">'default'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n\n                <span class=\"token comment\">/*\n                |--------------------------------------------------------------------------\n                | Channel Manager\n                |--------------------------------------------------------------------------\n                |\n                | The channel manager is responsible for storing, tracking and retrieving\n                | the channels as long as their members and connections.\n                |\n                */</span>\n\n                <span class=\"token string single-quoted-string\">'channel_manager'</span> <span class=\"token operator\">=></span> <span class=\"token class-name class-name-fully-qualified static-context\">BeyondCode<span class=\"token punctuation\">\\</span>LaravelWebSockets<span class=\"token punctuation\">\\</span>ChannelManagers<span class=\"token punctuation\">\\</span>RedisChannelManager</span><span class=\"token operator\">::</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">,</span>\n\n                <span class=\"token comment\">/*\n                |--------------------------------------------------------------------------\n                | Statistics Collector\n                |--------------------------------------------------------------------------\n                |\n                | The Statistics Collector will, by default, handle the incoming statistics,\n                | storing them until they will become dumped into another database, usually\n                | a MySQL database or a time-series database.\n                |\n                */</span>\n\n                <span class=\"token string single-quoted-string\">'collector'</span> <span class=\"token operator\">=></span> <span class=\"token class-name class-name-fully-qualified static-context\"><span class=\"token punctuation\">\\</span>BeyondCode<span class=\"token punctuation\">\\</span>LaravelWebSockets<span class=\"token punctuation\">\\</span>Statistics<span class=\"token punctuation\">\\</span>Collectors<span class=\"token punctuation\">\\</span>RedisCollector</span><span class=\"token operator\">::</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">,</span>\n\n            <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n\n        <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n\n    <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n\n    <span class=\"token string single-quoted-string\">'statistics'</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">[</span>\n\n        <span class=\"token comment\">/*\n        |--------------------------------------------------------------------------\n        | Statistics Store\n        |--------------------------------------------------------------------------\n        |\n        | The Statistics Store is the place where all the temporary stats will\n        | be dumped. This is a much reliable store and will be used to display\n        | graphs or handle it later on your app.\n        |\n        */</span>\n\n        <span class=\"token string single-quoted-string\">'store'</span> <span class=\"token operator\">=></span> <span class=\"token class-name class-name-fully-qualified static-context\"><span class=\"token punctuation\">\\</span>BeyondCode<span class=\"token punctuation\">\\</span>LaravelWebSockets<span class=\"token punctuation\">\\</span>Statistics<span class=\"token punctuation\">\\</span>Stores<span class=\"token punctuation\">\\</span>DatabaseStore</span><span class=\"token operator\">::</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">,</span>\n\n        <span class=\"token comment\">/*\n        |--------------------------------------------------------------------------\n        | Statistics Interval Period\n        |--------------------------------------------------------------------------\n        |\n        | Here you can specify the interval in seconds at which\n        | statistics should be logged.\n        |\n        */</span>\n\n        <span class=\"token string single-quoted-string\">'interval_in_seconds'</span> <span class=\"token operator\">=></span> <span class=\"token number\">60</span><span class=\"token punctuation\">,</span>\n\n        <span class=\"token comment\">/*\n        |--------------------------------------------------------------------------\n        | Statistics Deletion Period\n        |--------------------------------------------------------------------------\n        |\n        | When the clean-command is executed, all recorded statistics older than\n        | the number of days specified here will be deleted.\n        |\n        */</span>\n\n        <span class=\"token string single-quoted-string\">'delete_statistics_older_than_days'</span> <span class=\"token operator\">=></span> <span class=\"token number\">60</span><span class=\"token punctuation\">,</span>\n\n    <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n\n    <span class=\"token comment\">/*\n    |--------------------------------------------------------------------------\n    | Maximum Request Size\n    |--------------------------------------------------------------------------\n    |\n    | The maximum request size in kilobytes that is allowed for\n    | an incoming WebSocket request.\n    |\n    */</span>\n\n    <span class=\"token string single-quoted-string\">'max_request_size_in_kb'</span> <span class=\"token operator\">=></span> <span class=\"token number\">250</span><span class=\"token punctuation\">,</span>\n\n    <span class=\"token comment\">/*\n    |--------------------------------------------------------------------------\n    | SSL Configuration\n    |--------------------------------------------------------------------------\n    |\n    | By default, the configuration allows only on HTTP. For SSL, you need\n    | to set up the the certificate, the key, and optionally, the passphrase\n    | for the private key.\n    | You will need to restart the server for the settings to take place.\n    |\n    */</span>\n\n    <span class=\"token string single-quoted-string\">'ssl'</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">[</span>\n\n        <span class=\"token string single-quoted-string\">'local_cert'</span> <span class=\"token operator\">=></span> <span class=\"token function\">env</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'LARAVEL_WEBSOCKETS_SSL_LOCAL_CERT'</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">null</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n\n        <span class=\"token string single-quoted-string\">'capath'</span> <span class=\"token operator\">=></span> <span class=\"token function\">env</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'LARAVEL_WEBSOCKETS_SSL_CA'</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">null</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n\n        <span class=\"token string single-quoted-string\">'local_pk'</span> <span class=\"token operator\">=></span> <span class=\"token function\">env</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'LARAVEL_WEBSOCKETS_SSL_LOCAL_PK'</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">null</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n\n        <span class=\"token string single-quoted-string\">'passphrase'</span> <span class=\"token operator\">=></span> <span class=\"token function\">env</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'LARAVEL_WEBSOCKETS_SSL_PASSPHRASE'</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">null</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n\n        <span class=\"token string single-quoted-string\">'verify_peer'</span> <span class=\"token operator\">=></span> <span class=\"token function\">env</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'APP_ENV'</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">===</span> <span class=\"token string single-quoted-string\">'production'</span><span class=\"token punctuation\">,</span>\n\n        <span class=\"token string single-quoted-string\">'allow_self_signed'</span> <span class=\"token operator\">=></span> <span class=\"token function\">env</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'APP_ENV'</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">!==</span> <span class=\"token string single-quoted-string\">'production'</span><span class=\"token punctuation\">,</span>\n\n    <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n\n    <span class=\"token comment\">/*\n    |--------------------------------------------------------------------------\n    | Route Handlers\n    |--------------------------------------------------------------------------\n    |\n    | Here you can specify the route handlers that will take over\n    | the incoming/outgoing websocket connections. You can extend the\n    | original class and implement your own logic, alongside\n    | with the existing logic.\n    |\n    */</span>\n\n    <span class=\"token string single-quoted-string\">'handlers'</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">[</span>\n\n        <span class=\"token string single-quoted-string\">'websocket'</span> <span class=\"token operator\">=></span> <span class=\"token class-name class-name-fully-qualified static-context\"><span class=\"token punctuation\">\\</span>App<span class=\"token punctuation\">\\</span>Services<span class=\"token punctuation\">\\</span>WebSockets<span class=\"token punctuation\">\\</span>Server<span class=\"token punctuation\">\\</span>WebSocketHandler</span><span class=\"token operator\">::</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">,</span>\n\n        <span class=\"token string single-quoted-string\">'health'</span> <span class=\"token operator\">=></span> <span class=\"token class-name class-name-fully-qualified static-context\"><span class=\"token punctuation\">\\</span>BeyondCode<span class=\"token punctuation\">\\</span>LaravelWebSockets<span class=\"token punctuation\">\\</span>Server<span class=\"token punctuation\">\\</span>HealthHandler</span><span class=\"token operator\">::</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">,</span>\n\n        <span class=\"token string single-quoted-string\">'trigger_event'</span> <span class=\"token operator\">=></span> <span class=\"token class-name class-name-fully-qualified static-context\"><span class=\"token punctuation\">\\</span>BeyondCode<span class=\"token punctuation\">\\</span>LaravelWebSockets<span class=\"token punctuation\">\\</span>API<span class=\"token punctuation\">\\</span>TriggerEvent</span><span class=\"token operator\">::</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">,</span>\n\n        <span class=\"token string single-quoted-string\">'fetch_channels'</span> <span class=\"token operator\">=></span> <span class=\"token class-name class-name-fully-qualified static-context\"><span class=\"token punctuation\">\\</span>BeyondCode<span class=\"token punctuation\">\\</span>LaravelWebSockets<span class=\"token punctuation\">\\</span>API<span class=\"token punctuation\">\\</span>FetchChannels</span><span class=\"token operator\">::</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">,</span>\n\n        <span class=\"token string single-quoted-string\">'fetch_channel'</span> <span class=\"token operator\">=></span> <span class=\"token class-name class-name-fully-qualified static-context\"><span class=\"token punctuation\">\\</span>BeyondCode<span class=\"token punctuation\">\\</span>LaravelWebSockets<span class=\"token punctuation\">\\</span>API<span class=\"token punctuation\">\\</span>FetchChannel</span><span class=\"token operator\">::</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">,</span>\n\n        <span class=\"token string single-quoted-string\">'fetch_users'</span> <span class=\"token operator\">=></span> <span class=\"token class-name class-name-fully-qualified static-context\"><span class=\"token punctuation\">\\</span>BeyondCode<span class=\"token punctuation\">\\</span>LaravelWebSockets<span class=\"token punctuation\">\\</span>API<span class=\"token punctuation\">\\</span>FetchUsers</span><span class=\"token operator\">::</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">,</span>\n\n    <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n\n    <span class=\"token comment\">/*\n    |--------------------------------------------------------------------------\n    | Promise Resolver\n    |--------------------------------------------------------------------------\n    |\n    | The promise resolver is a class that takes a input value and is\n    | able to make sure the PHP code runs async by using ->then(). You can\n    | use your own Promise Resolver. This is usually changed when you want to\n    | intercept values by the promises throughout the app, like in testing\n    | to switch from async to sync.\n    |\n    */</span>\n\n    <span class=\"token string single-quoted-string\">'promise_resolver'</span> <span class=\"token operator\">=></span> <span class=\"token class-name class-name-fully-qualified static-context\"><span class=\"token punctuation\">\\</span>React<span class=\"token punctuation\">\\</span>Promise<span class=\"token punctuation\">\\</span>FulfilledPromise</span><span class=\"token operator\">::</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">,</span>\n\n<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n</p>\n</details>\n<p>修改<strong>broadcasting.php</strong>，以实现同时在两个app中进行广播</p>\n<details class=\"custom-details\">\n<summary>Click to see more</summary>\n<p><pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\"><span class=\"token php language-php\"><span class=\"token delimiter important\">&lt;?php</span>\n\n<span class=\"token keyword\">return</span> <span class=\"token punctuation\">[</span>\n\n    <span class=\"token comment\">/*\n    |--------------------------------------------------------------------------\n    | Default Broadcaster\n    |--------------------------------------------------------------------------\n    |\n    | This option controls the default broadcaster that will be used by the\n    | framework when an event needs to be broadcast. You may set this to\n    | any of the connections defined in the \"connections\" array below.\n    |\n    | Supported: \"pusher\", \"redis\", \"log\", \"null\"\n    |\n    */</span>\n\n    <span class=\"token string single-quoted-string\">'default'</span> <span class=\"token operator\">=></span> <span class=\"token function\">env</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'BROADCAST_DRIVER'</span><span class=\"token punctuation\">,</span> <span class=\"token string single-quoted-string\">'null'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n\n    <span class=\"token comment\">/*\n    |--------------------------------------------------------------------------\n    | Broadcast Connections\n    |--------------------------------------------------------------------------\n    |\n    | Here you may define all of the broadcast connections that will be used\n    | to broadcast events to other systems or over websockets. Samples of\n    | each available type of connection are provided inside this array.\n    |\n    */</span>\n\n    <span class=\"token string single-quoted-string\">'connections'</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">[</span>\n\n        <span class=\"token string single-quoted-string\">'pusher'</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">[</span>\n            <span class=\"token string single-quoted-string\">'driver'</span> <span class=\"token operator\">=></span> <span class=\"token string single-quoted-string\">'multiple'</span><span class=\"token punctuation\">,</span>\n            <span class=\"token string single-quoted-string\">'connections'</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'pusher-for-admin'</span><span class=\"token punctuation\">,</span> <span class=\"token string single-quoted-string\">'pusher-for-api'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n            <span class=\"token string single-quoted-string\">'options'</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">[</span>\n                <span class=\"token string single-quoted-string\">'cluster'</span> <span class=\"token operator\">=></span> <span class=\"token string single-quoted-string\">'mt1'</span><span class=\"token punctuation\">,</span>\n                <span class=\"token string single-quoted-string\">'useTLS'</span> <span class=\"token operator\">=></span> <span class=\"token constant boolean\">true</span><span class=\"token punctuation\">,</span>\n                <span class=\"token string single-quoted-string\">'encrypted'</span> <span class=\"token operator\">=></span> <span class=\"token constant boolean\">true</span><span class=\"token punctuation\">,</span>\n                <span class=\"token string single-quoted-string\">'host'</span> <span class=\"token operator\">=></span> <span class=\"token string single-quoted-string\">'127.0.0.1'</span><span class=\"token punctuation\">,</span>\n                <span class=\"token string single-quoted-string\">'port'</span> <span class=\"token operator\">=></span> <span class=\"token number\">6001</span><span class=\"token punctuation\">,</span>\n                <span class=\"token string single-quoted-string\">'scheme'</span> <span class=\"token operator\">=></span> <span class=\"token string single-quoted-string\">'http'</span><span class=\"token punctuation\">,</span>\n            <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n        <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n\n        <span class=\"token string single-quoted-string\">'pusher-for-admin'</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">[</span>\n            <span class=\"token string single-quoted-string\">'driver'</span> <span class=\"token operator\">=></span> <span class=\"token string single-quoted-string\">'pusher'</span><span class=\"token punctuation\">,</span>\n            <span class=\"token string single-quoted-string\">'key'</span> <span class=\"token operator\">=></span> <span class=\"token string single-quoted-string\">'admin-app-key'</span><span class=\"token punctuation\">,</span>\n            <span class=\"token string single-quoted-string\">'secret'</span> <span class=\"token operator\">=></span> <span class=\"token string single-quoted-string\">'admin-app-secret'</span><span class=\"token punctuation\">,</span>\n            <span class=\"token string single-quoted-string\">'app_id'</span> <span class=\"token operator\">=></span> <span class=\"token string single-quoted-string\">'admin-app-id'</span><span class=\"token punctuation\">,</span>\n            <span class=\"token string single-quoted-string\">'options'</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">[</span>\n                <span class=\"token string single-quoted-string\">'cluster'</span> <span class=\"token operator\">=></span> <span class=\"token string single-quoted-string\">'mt1'</span><span class=\"token punctuation\">,</span>\n                <span class=\"token string single-quoted-string\">'useTLS'</span> <span class=\"token operator\">=></span> <span class=\"token constant boolean\">true</span><span class=\"token punctuation\">,</span>\n                <span class=\"token string single-quoted-string\">'encrypted'</span> <span class=\"token operator\">=></span> <span class=\"token constant boolean\">true</span><span class=\"token punctuation\">,</span>\n                <span class=\"token string single-quoted-string\">'host'</span> <span class=\"token operator\">=></span> <span class=\"token string single-quoted-string\">'127.0.0.1'</span><span class=\"token punctuation\">,</span>\n                <span class=\"token string single-quoted-string\">'port'</span> <span class=\"token operator\">=></span> <span class=\"token number\">6001</span><span class=\"token punctuation\">,</span>\n                <span class=\"token string single-quoted-string\">'scheme'</span> <span class=\"token operator\">=></span> <span class=\"token string single-quoted-string\">'http'</span><span class=\"token punctuation\">,</span>\n            <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n        <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n\n        <span class=\"token string single-quoted-string\">'pusher-for-api'</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">[</span>\n            <span class=\"token string single-quoted-string\">'driver'</span> <span class=\"token operator\">=></span> <span class=\"token string single-quoted-string\">'pusher'</span><span class=\"token punctuation\">,</span>\n            <span class=\"token string single-quoted-string\">'key'</span> <span class=\"token operator\">=></span> <span class=\"token string single-quoted-string\">'api-app-key'</span><span class=\"token punctuation\">,</span>\n            <span class=\"token string single-quoted-string\">'secret'</span> <span class=\"token operator\">=></span> <span class=\"token string single-quoted-string\">'api-app-secret'</span><span class=\"token punctuation\">,</span>\n            <span class=\"token string single-quoted-string\">'app_id'</span> <span class=\"token operator\">=></span> <span class=\"token string single-quoted-string\">'api-app-id'</span><span class=\"token punctuation\">,</span>\n            <span class=\"token string single-quoted-string\">'options'</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">[</span>\n                <span class=\"token string single-quoted-string\">'cluster'</span> <span class=\"token operator\">=></span> <span class=\"token string single-quoted-string\">'mt1'</span><span class=\"token punctuation\">,</span>\n                <span class=\"token string single-quoted-string\">'useTLS'</span> <span class=\"token operator\">=></span> <span class=\"token constant boolean\">true</span><span class=\"token punctuation\">,</span>\n                <span class=\"token string single-quoted-string\">'encrypted'</span> <span class=\"token operator\">=></span> <span class=\"token constant boolean\">true</span><span class=\"token punctuation\">,</span>\n                <span class=\"token string single-quoted-string\">'host'</span> <span class=\"token operator\">=></span> <span class=\"token string single-quoted-string\">'127.0.0.1'</span><span class=\"token punctuation\">,</span>\n                <span class=\"token string single-quoted-string\">'port'</span> <span class=\"token operator\">=></span> <span class=\"token number\">6001</span><span class=\"token punctuation\">,</span>\n                <span class=\"token string single-quoted-string\">'scheme'</span> <span class=\"token operator\">=></span> <span class=\"token string single-quoted-string\">'http'</span><span class=\"token punctuation\">,</span>\n            <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n        <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n\n        <span class=\"token string single-quoted-string\">'redis'</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">[</span>\n            <span class=\"token string single-quoted-string\">'driver'</span> <span class=\"token operator\">=></span> <span class=\"token string single-quoted-string\">'redis'</span><span class=\"token punctuation\">,</span>\n            <span class=\"token string single-quoted-string\">'connection'</span> <span class=\"token operator\">=></span> <span class=\"token string single-quoted-string\">'default'</span><span class=\"token punctuation\">,</span>\n        <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n\n        <span class=\"token string single-quoted-string\">'log'</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">[</span>\n            <span class=\"token string single-quoted-string\">'driver'</span> <span class=\"token operator\">=></span> <span class=\"token string single-quoted-string\">'log'</span><span class=\"token punctuation\">,</span>\n        <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n\n        <span class=\"token string single-quoted-string\">'null'</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">[</span>\n            <span class=\"token string single-quoted-string\">'driver'</span> <span class=\"token operator\">=></span> <span class=\"token string single-quoted-string\">'null'</span><span class=\"token punctuation\">,</span>\n        <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n\n    <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n\n<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n</p>\n</details>\n<p>最后将ENV文件中的<code>BROADCAST_DRIVER</code>改为pusher即可。</p>\n<h3 id=\"启动\"><a href=\"#启动\" class=\"headerlink\" title=\"启动\"></a>启动</h3><pre class=\"line-numbers language-none\"><code class=\"language-none\">php artisan websockets:serve<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<h3 id=\"客户端接入\"><a href=\"#客户端接入\" class=\"headerlink\" title=\"客户端接入\"></a>客户端接入</h3><p>后台Nodejs</p>\n<pre class=\"line-numbers language-javascript\" data-language=\"javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">import</span> Echo <span class=\"token keyword\">from</span> <span class=\"token string\">'laravel-echo'</span><span class=\"token punctuation\">;</span>\n\nwindow<span class=\"token punctuation\">.</span>Pusher <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'pusher-js'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\nwindow<span class=\"token punctuation\">.</span>Echo <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Echo</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span>\n  broadcaster<span class=\"token operator\">:</span> <span class=\"token string\">'pusher'</span><span class=\"token punctuation\">,</span>\n  key<span class=\"token operator\">:</span> <span class=\"token string\">'admin-app-key'</span><span class=\"token punctuation\">,</span>\n  wsHost<span class=\"token operator\">:</span> window<span class=\"token punctuation\">.</span>location<span class=\"token punctuation\">.</span>hostname<span class=\"token punctuation\">,</span>\n  wsPort<span class=\"token operator\">:</span> <span class=\"token number\">6001</span><span class=\"token punctuation\">,</span>\n  forceTLS<span class=\"token operator\">:</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span>\n  disableStats<span class=\"token operator\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>Android 使用 <a href=\"https://github.com/pusher/pusher-websocket-java\">pusher-websocket-java</a> SDK<br>IOS 使用 <a href=\"https://github.com/pusher/pusher-websocket-swift\">pusher-websocket-swift</a> SDK</p>\n<p>连接参数</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">host: &#123;Websocket服务域名&#125; (我这边和laravel项目域名是同一个)\nport: 6001\napp_key: api-app-key\nauth_url: &#123;laravel项目域名&#125;&#x2F;broadcasting&#x2F;auth<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span></span></code></pre>\n\n<div class=\"custom-quote danger\">\n<span class=\"custom-quote-svg\"><svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"\" xmlns=\"http://www.w3.org/2000/svg\" data-reactroot=\"\">\n<path fill=\"\" d=\"M19.76 5.23C15.84 5.23 12 2 12 2C12 2 8.15996 5.23 4.23996 5.23C4.23996 5.23 1.86996 16.99 12 22C22.13 16.99 19.76 5.23 19.76 5.23Z\" undefined=\"1\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M12 8V13\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M11.99 16H12\"></path>\n</svg>\n</span>\n<p class=\"custom-quote-title\">特别注意</p>\n<p>注意pusher-websocket-swift要使用8.0.0版本，9.x版本有bug无法连接服务</p>\n</div>\n","feature":true,"text":"给Laravel项目搭建Websocket服务时，不想用pusher这种在线服务? 觉得用laravel-echo-server监听事件不方便? 不想用swoole自己实现? 那你可以考虑Laravel官方推荐的laravel-websockets组件。 该组件有以下优点: 免费...","link":"","photos":[],"count_time":{"symbolsCount":"30k","symbolsTime":"27 mins."},"categories":[{"name":"php","slug":"php","count":13,"path":"api/categories/php.json"}],"tags":[{"name":"laravel","slug":"laravel","count":10,"path":"api/tags/laravel.json"},{"name":"websocket","slug":"websocket","count":1,"path":"api/tags/websocket.json"}],"toc":"<ol class=\"toc\"><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#%E5%BC%95%E5%85%A5\"><span class=\"toc-text\">引入</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#%E5%AE%89%E8%A3%85\"><span class=\"toc-text\">安装</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#%E8%87%AA%E5%AE%9A%E4%B9%89\"><span class=\"toc-text\">自定义</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-4\"><a class=\"toc-link\" href=\"#%E9%9C%80%E6%B1%82\"><span class=\"toc-text\">需求</span></a></li><li class=\"toc-item toc-level-4\"><a class=\"toc-link\" href=\"#%E4%BA%8B%E4%BB%B6\"><span class=\"toc-text\">事件</span></a></li><li class=\"toc-item toc-level-4\"><a class=\"toc-link\" href=\"#%E9%A2%91%E9%81%93\"><span class=\"toc-text\">频道</span></a></li></ol></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#%E9%85%8D%E7%BD%AE\"><span class=\"toc-text\">配置</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#%E5%90%AF%E5%8A%A8\"><span class=\"toc-text\">启动</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#%E5%AE%A2%E6%88%B7%E7%AB%AF%E6%8E%A5%E5%85%A5\"><span class=\"toc-text\">客户端接入</span></a></li></ol>","author":{"name":"CloudyCity","slug":"blog-author","avatar":"https://avatars.githubusercontent.com/u/17662451?s=400&u=643d94296b79c5e8424a2177fc4609a5e0ebeae0&v=4","link":"/","description":"拖延并发强迫症懒癌晚期患者","socials":{"github":"https://github.com/CloudyCity","twitter":"","stackoverflow":"https://stackoverflow.com/users/9827779/cloudycity","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"","juejin":"","customs":{"bilibili":{"icon":"/svg/bilibili.svg","link":"https://b23.tv/MK4nKb"},"steam":{"icon":"/svg/steam.svg","link":"https://steamcommunity.com/id/cloudycity"}}}},"mapped":true,"prev_post":{"title":"GitLab CI/CD简单实践","uid":"b2664a00c0b23f7c33471554c1cc3622","slug":"GitLab-CI-CD简单实践","date":"2021-05-28T03:23:58.000Z","updated":"2021-06-21T10:35:56.783Z","comments":true,"path":"api/articles/GitLab-CI-CD简单实践.json","cover":"https://www.rapidvaluesolutions.com/wp-content/uploads/2020/09/Blog-9.png","text":"针对一个前端项目仓库，使用简单、低成本的方式进行CI/CD。 简介GitLab CI/CD通过GitLab Runner实现。流程为：由GitLab触发流水线，通知安装在部署机上的Runner，然后Runner配置的Executor执行gitlab-ci.yml中的流程。 Git...","link":"","photos":[],"count_time":{"symbolsCount":"1.9k","symbolsTime":"2 mins."},"categories":[{"name":"前端","slug":"前端","count":4,"path":"api/categories/前端.json"},{"name":"运维","slug":"前端/运维","count":1,"path":"api/categories/前端/运维.json"}],"tags":[{"name":"gitlab","slug":"gitlab","count":1,"path":"api/tags/gitlab.json"}],"author":{"name":"CloudyCity","slug":"blog-author","avatar":"https://avatars.githubusercontent.com/u/17662451?s=400&u=643d94296b79c5e8424a2177fc4609a5e0ebeae0&v=4","link":"/","description":"拖延并发强迫症懒癌晚期患者","socials":{"github":"https://github.com/CloudyCity","twitter":"","stackoverflow":"https://stackoverflow.com/users/9827779/cloudycity","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"","juejin":"","customs":{"bilibili":{"icon":"/svg/bilibili.svg","link":"https://b23.tv/MK4nKb"},"steam":{"icon":"/svg/steam.svg","link":"https://steamcommunity.com/id/cloudycity"}}}},"feature":true},"next_post":{"title":"PHP强制规范检查的最佳实践","uid":"7383adf578f96139725a89cef1cef06f","slug":"PHP强制规范检查的最佳实践","date":"2021-01-29T08:25:35.000Z","updated":"2021-06-21T10:35:56.782Z","comments":true,"path":"api/articles/PHP强制规范检查的最佳实践.json","cover":"https://d1xmlzncnovrpo.cloudfront.net/sites/default/files/public/blog-image/PHP_CodeSniffer-Ignoring-Standards.jpg","text":"规范是团队中最重要的部分之一，多数团队是靠自觉+review维护规范，而强制检查是最有效的方案。本文就水一下介绍下PHP_CodeSniffer在项目中强制执行的最佳实践。 规范检查和表单检验一样，服务端是必须要检查的，客户端检查主要是优化使用体验。 客户端引入组件$ compo...","link":"","photos":[],"count_time":{"symbolsCount":"11k","symbolsTime":"10 mins."},"categories":[{"name":"php","slug":"php","count":13,"path":"api/categories/php.json"}],"tags":[],"author":{"name":"CloudyCity","slug":"blog-author","avatar":"https://avatars.githubusercontent.com/u/17662451?s=400&u=643d94296b79c5e8424a2177fc4609a5e0ebeae0&v=4","link":"/","description":"拖延并发强迫症懒癌晚期患者","socials":{"github":"https://github.com/CloudyCity","twitter":"","stackoverflow":"https://stackoverflow.com/users/9827779/cloudycity","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"","juejin":"","customs":{"bilibili":{"icon":"/svg/bilibili.svg","link":"https://b23.tv/MK4nKb"},"steam":{"icon":"/svg/steam.svg","link":"https://steamcommunity.com/id/cloudycity"}}}},"feature":true}}