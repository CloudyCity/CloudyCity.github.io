{"title":"Laravel使用RequestID的简易方案","uid":"a29498d15b755e71f5f5106950806aeb","slug":"Laravel使用RequestID的简易方案","date":"2021-06-21T10:22:24.000Z","updated":"2021-09-02T03:35:18.934Z","comments":true,"path":"api/articles/Laravel使用RequestID的简易方案.json","cover":"https://bs-uploads.toptal.io/blackfish-uploads/blog/article/content/cover_image_file/cover_image/268618/retina_500x200__0602_Publications_Engineering__Laravel_Passport_Part_1-3_Zara_Newsletter___blog-11e3d466c241197a1a2fc0428ff1ef05.png","content":"<p>一些大型Web系统通常会给请求分配一个UUID，便于追踪定位线上的问题。</p>\n<p>这部分的功能可以细分为：</p>\n<ul>\n<li>分配UUID</li>\n<li>存储请求</li>\n<li>检索请求</li>\n</ul>\n<h2 id=\"分配UUID\"><a href=\"#分配UUID\" class=\"headerlink\" title=\"分配UUID\"></a>分配UUID</h2><p>这部分比较简单，写个中间件并注册即可：</p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\"><span class=\"token php language-php\"><span class=\"token delimiter important\">&lt;?php</span>\n\n<span class=\"token keyword\">namespace</span> <span class=\"token package\">App<span class=\"token punctuation\">\\</span>Http<span class=\"token punctuation\">\\</span>Middleware</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">use</span> <span class=\"token package\">Illuminate<span class=\"token punctuation\">\\</span>Http<span class=\"token punctuation\">\\</span>JsonResponse</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">use</span> <span class=\"token package\">Illuminate<span class=\"token punctuation\">\\</span>Http<span class=\"token punctuation\">\\</span>Request</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">use</span> <span class=\"token package\">Illuminate<span class=\"token punctuation\">\\</span>Http<span class=\"token punctuation\">\\</span>Response</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">use</span> <span class=\"token package\">Laravel<span class=\"token punctuation\">\\</span>Telescope<span class=\"token punctuation\">\\</span>Watchers<span class=\"token punctuation\">\\</span>RequestWatcher</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">use</span> <span class=\"token package\">Ramsey<span class=\"token punctuation\">\\</span>Uuid<span class=\"token punctuation\">\\</span>Uuid</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">AppendRequestId</span>\n<span class=\"token punctuation\">&#123;</span>\n    <span class=\"token comment\">/**\n     * 为请求分配一个ID\n     *\n     * @param  \\Illuminate\\Http\\Request  $request\n     * @param \\Closure $next\n     * @return mixed\n     */</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">function</span> <span class=\"token function\">handle</span><span class=\"token punctuation\">(</span><span class=\"token class-name type-declaration\">Request</span> <span class=\"token variable\">$request</span><span class=\"token punctuation\">,</span> <span class=\"token class-name class-name-fully-qualified type-declaration\"><span class=\"token punctuation\">\\</span>Closure</span> <span class=\"token variable\">$next</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">&#123;</span>\n        <span class=\"token variable\">$uuid</span> <span class=\"token operator\">=</span> <span class=\"token class-name static-context\">Uuid</span><span class=\"token operator\">::</span><span class=\"token function\">uuid6</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">-></span><span class=\"token function\">toString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token variable\">$request</span><span class=\"token operator\">-></span><span class=\"token property\">headers</span><span class=\"token operator\">-></span><span class=\"token function\">set</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'X-Request-ID'</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$uuid</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token comment\">/** @var Response $response */</span>\n        <span class=\"token variable\">$response</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$next</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$request</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token variable\">$response</span><span class=\"token operator\">-></span><span class=\"token property\">headers</span><span class=\"token operator\">-></span><span class=\"token function\">set</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'X-Request-ID'</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$uuid</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token variable\">$response</span> <span class=\"token keyword\">instanceof</span> <span class=\"token class-name\">JsonResponse</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n            <span class=\"token variable\">$response</span><span class=\"token operator\">-></span><span class=\"token function\">setData</span><span class=\"token punctuation\">(</span><span class=\"token function\">tap</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$response</span><span class=\"token operator\">-></span><span class=\"token function\">getData</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token variable\">$data</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">use</span> <span class=\"token punctuation\">(</span><span class=\"token variable\">$uuid</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n                <span class=\"token variable\">$data</span><span class=\"token operator\">-></span><span class=\"token property\">request_id</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$uuid</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">&#125;</span>\n\n        <span class=\"token keyword\">return</span> <span class=\"token variable\">$response</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">&#125;</span>\n<span class=\"token punctuation\">&#125;</span></span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p><img src=\"https://user-images.githubusercontent.com/17662451/122746335-7d220c00-d2bc-11eb-9e00-0e6830f463f1.png\" alt=\"image\"></p>\n<p><img src=\"https://user-images.githubusercontent.com/17662451/122746428-9460f980-d2bc-11eb-90e2-b6abc87b0ec7.png\" alt=\"image\"></p>\n<h2 id=\"存储请求\"><a href=\"#存储请求\" class=\"headerlink\" title=\"存储请求\"></a>存储请求</h2><p>这里推荐 Laravel 官方组件 <a href=\"https://laravel.com/docs/master/telescope\">Telescope</a> , 安装过程见官方文档。</p>\n<div class=\"custom-quote warning\">\n<span class=\"custom-quote-svg\"><svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"\" xmlns=\"http://www.w3.org/2000/svg\" data-reactroot=\"\">\n<path fill=\"\" d=\"M20.86 14.13C20 14.7 19.56 15.74 19.77 16.76C20.13 18.55 18.55 20.13 16.76 19.77C15.74 19.57 14.7 20 14.13 20.86C13.12 22.38 10.89 22.38 9.88 20.86C9.3 20 8.26 19.56 7.24 19.77C5.45 20.13 3.87 18.55 4.23 16.76C4.43 15.74 4 14.7 3.14 14.13C1.62 13.12 1.62 10.89 3.14 9.88C4 9.3 4.44 8.26 4.23 7.24C3.87 5.45 5.45 3.87 7.24 4.23C8.26 4.44 9.3 4 9.87 3.14C10.88 1.62 13.11 1.62 14.12 3.14C14.7 4 15.74 4.44 16.76 4.23C18.55 3.87 20.13 5.45 19.77 7.24C19.56 8.26 20 9.3 20.86 9.87C22.38 10.88 22.38 13.12 20.86 14.13Z\" undefined=\"1\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M12 8V13\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M12 15.99V16.01\"></path>\n</svg>\n</span>\n<p class=\"custom-quote-title\">注意</p>\n<p><code>Telescope</code>会对服务器性能有一些影响，不过你可以通过<code>.env</code>管理<code>Watcher</code>，确保线上只开启必要的<code>Watcher</code>，可以减少影响。</p>\n</div>\n<p><code>Telescope</code>使用<code>Tag</code>进行检索，所以我们需要把上面生成的UUID保存到<code>Tag</code>中。</p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\"><span class=\"token php language-php\"><span class=\"token delimiter important\">&lt;?php</span>\n\n<span class=\"token keyword\">namespace</span> <span class=\"token package\">App<span class=\"token punctuation\">\\</span>Providers</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">use</span> <span class=\"token package\">App<span class=\"token punctuation\">\\</span>Models<span class=\"token punctuation\">\\</span>System<span class=\"token punctuation\">\\</span>Admin</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">use</span> <span class=\"token package\">Illuminate<span class=\"token punctuation\">\\</span>Support<span class=\"token punctuation\">\\</span>Facades<span class=\"token punctuation\">\\</span>Gate</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">use</span> <span class=\"token package\">Laravel<span class=\"token punctuation\">\\</span>Telescope<span class=\"token punctuation\">\\</span>IncomingEntry</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">use</span> <span class=\"token package\">Laravel<span class=\"token punctuation\">\\</span>Telescope<span class=\"token punctuation\">\\</span>Telescope</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">use</span> <span class=\"token package\">Laravel<span class=\"token punctuation\">\\</span>Telescope<span class=\"token punctuation\">\\</span>TelescopeApplicationServiceProvider</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">TelescopeServiceProvider</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">TelescopeApplicationServiceProvider</span>\n<span class=\"token punctuation\">&#123;</span>\n    <span class=\"token comment\">/**\n     * Register any application services.\n     *\n     * @return void\n     */</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">function</span> <span class=\"token function\">register</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">&#123;</span>\n        <span class=\"token comment\">// ...</span>\n\n        <span class=\"token class-name static-context\">Telescope</span><span class=\"token operator\">::</span><span class=\"token function\">tag</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token class-name type-declaration\">IncomingEntry</span> <span class=\"token variable\">$entry</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token variable\">$entry</span><span class=\"token operator\">-></span><span class=\"token property\">type</span> <span class=\"token operator\">===</span> <span class=\"token string single-quoted-string\">'request'</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token variable\">$requestId</span> <span class=\"token operator\">=</span> <span class=\"token function\">request</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">-></span><span class=\"token property\">headers</span><span class=\"token operator\">-></span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'x-request-id'</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">null</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n                <span class=\"token keyword\">return</span> <span class=\"token punctuation\">[</span><span class=\"token variable\">$requestId</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">&#125;</span>\n            <span class=\"token keyword\">return</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">&#125;</span>\n\n    <span class=\"token comment\">// ...</span></span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h2 id=\"检索请求\"><a href=\"#检索请求\" class=\"headerlink\" title=\"检索请求\"></a>检索请求</h2><p><img src=\"https://user-images.githubusercontent.com/17662451/122746633-ca05e280-d2bc-11eb-894e-b2b34df5628c.png\" alt=\"image\"></p>\n<p><img src=\"https://user-images.githubusercontent.com/17662451/122747104-3da7ef80-d2bd-11eb-8a65-f15c61a0ee67.png\" alt=\"image\"></p>\n<div class=\"custom-quote tip\">\n<span class=\"custom-quote-svg\"><svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"\" xmlns=\"http://www.w3.org/2000/svg\" data-reactroot=\"\">\n<path fill=\"\" d=\"M20.86 14.13C20 14.7 19.56 15.74 19.77 16.76C20.13 18.55 18.55 20.13 16.76 19.77C15.74 19.57 14.7 20 14.13 20.86C13.12 22.38 10.89 22.38 9.88 20.86C9.3 20 8.26 19.56 7.24 19.77C5.45 20.13 3.87 18.55 4.23 16.76C4.43 15.74 4 14.7 3.14 14.13C1.62 13.12 1.62 10.89 3.14 9.88C4 9.3 4.44 8.26 4.23 7.24C3.87 5.45 5.45 3.87 7.24 4.23C8.26 4.44 9.3 4 9.87 3.14C10.88 1.62 13.11 1.62 14.12 3.14C14.7 4 15.74 4.44 16.76 4.23C18.55 3.87 20.13 5.45 19.77 7.24C19.56 8.26 20 9.3 20.86 9.87C22.38 10.88 22.38 13.12 20.86 14.13Z\" undefined=\"1\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M12.01 15C12.01 14.5 12.01 14.5 12.01 14.5C12.04 13.75 13 13.46 14.04 12.2C14.41 11.74 14.69 11.41 14.86 10.85C15.15 9.95 14.92 9.18 14.86 9.02C14.8 8.79 14.52 8 13.72 7.46C13.06 7.02 12.42 7 12.14 7C11.9 7 11.36 7 10.78 7.3C10.28 7.56 9.98 7.9 9.83 8.1C9.24 8.82 9.06 9.63 9 10.06\"></path>\n<path stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M11.99 18H12.01\"></path>\n</svg></span>\n<p class=\"custom-quote-title\">提示</p>\n<p>细心的朋友可能会发现<code>Telescope</code>本身有UUID，那直接用这个作为请求ID岂不美哉？可惜的是，这个UUID在发送响应给客户端之后才产生的，没办法利用起来，参考 <a href=\"https://github.com/laravel/telescope/issues/451\">Issue</a>。</p>\n</div>\n","text":"一些大型Web系统通常会给请求分配一个UUID，便于追踪定位线上的问题。 这部分的功能可以细分为： 分配UUID 存储请求 检索请求 分配UUID这部分比较简单，写个中间件并注册即可： &lt;?php namespace App\\Http\\Middleware; use Ill...","link":"","photos":[],"count_time":{"symbolsCount":"2.1k","symbolsTime":"2 mins."},"categories":[{"name":"php","slug":"php","count":13,"path":"api/categories/php.json"}],"tags":[{"name":"laravel","slug":"laravel","count":10,"path":"api/tags/laravel.json"}],"toc":"<ol class=\"toc\"><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E5%88%86%E9%85%8DUUID\"><span class=\"toc-text\">分配UUID</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E5%AD%98%E5%82%A8%E8%AF%B7%E6%B1%82\"><span class=\"toc-text\">存储请求</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E6%A3%80%E7%B4%A2%E8%AF%B7%E6%B1%82\"><span class=\"toc-text\">检索请求</span></a></li></ol>","author":{"name":"CloudyCity","slug":"blog-author","avatar":"https://avatars.githubusercontent.com/u/17662451?s=400&u=643d94296b79c5e8424a2177fc4609a5e0ebeae0&v=4","link":"/","description":"拖延并发强迫症懒癌晚期患者","socials":{"github":"https://github.com/CloudyCity","twitter":"","stackoverflow":"https://stackoverflow.com/users/9827779/cloudycity","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"","juejin":"","customs":{"bilibili":{"icon":"/svg/bilibili.svg","link":"https://b23.tv/MK4nKb"},"steam":{"icon":"/svg/steam.svg","link":"https://steamcommunity.com/id/cloudycity"}}}},"mapped":true,"prev_post":{"title":"PHP强制规范检查的最佳实践","uid":"7383adf578f96139725a89cef1cef06f","slug":"PHP强制规范检查的最佳实践","date":"2021-01-29T08:25:35.000Z","updated":"2021-09-02T03:35:18.934Z","comments":true,"path":"api/articles/PHP强制规范检查的最佳实践.json","cover":"https://d1xmlzncnovrpo.cloudfront.net/sites/default/files/public/blog-image/PHP_CodeSniffer-Ignoring-Standards.jpg","text":"规范是团队中最重要的部分之一，多数团队是靠自觉+review维护规范，而强制检查是最有效的方案。本文就水一下介绍下PHP_CodeSniffer在项目中强制执行的最佳实践。 规范检查和表单检验一样，服务端是必须要检查的，客户端检查主要是优化使用体验。 客户端引入组件$ compo...","link":"","photos":[],"count_time":{"symbolsCount":"11k","symbolsTime":"10 mins."},"categories":[{"name":"php","slug":"php","count":13,"path":"api/categories/php.json"}],"tags":[],"author":{"name":"CloudyCity","slug":"blog-author","avatar":"https://avatars.githubusercontent.com/u/17662451?s=400&u=643d94296b79c5e8424a2177fc4609a5e0ebeae0&v=4","link":"/","description":"拖延并发强迫症懒癌晚期患者","socials":{"github":"https://github.com/CloudyCity","twitter":"","stackoverflow":"https://stackoverflow.com/users/9827779/cloudycity","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"","juejin":"","customs":{"bilibili":{"icon":"/svg/bilibili.svg","link":"https://b23.tv/MK4nKb"},"steam":{"icon":"/svg/steam.svg","link":"https://steamcommunity.com/id/cloudycity"}}}},"feature":true},"next_post":{"title":"Laravel优雅地支持多SMS","uid":"54163d6395a4d14b28c019a0ae6d39e3","slug":"Laravel优雅地支持多SMS","date":"2021-01-29T10:23:49.000Z","updated":"2021-09-02T03:35:18.934Z","comments":true,"path":"api/articles/Laravel优雅地支持多SMS.json","cover":"https://miro.medium.com/max/1200/1*TqJCpGhLCZixYW6Y8xMVbg.jpeg","text":"小公司可能为了节省短信成本，会选择多家短信服务商，但短信本身的模板不会太多。本文介绍下Laravel下如何优雅地实现这种场景。 依赖Laravel社区一个很赞的枚举组件 composer require bensampo/laravel-enum 这里以腾讯短信为例 compos...","link":"","photos":[],"count_time":{"symbolsCount":"12k","symbolsTime":"11 mins."},"categories":[{"name":"php","slug":"php","count":13,"path":"api/categories/php.json"}],"tags":[{"name":"laravel","slug":"laravel","count":10,"path":"api/tags/laravel.json"}],"author":{"name":"CloudyCity","slug":"blog-author","avatar":"https://avatars.githubusercontent.com/u/17662451?s=400&u=643d94296b79c5e8424a2177fc4609a5e0ebeae0&v=4","link":"/","description":"拖延并发强迫症懒癌晚期患者","socials":{"github":"https://github.com/CloudyCity","twitter":"","stackoverflow":"https://stackoverflow.com/users/9827779/cloudycity","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"","juejin":"","customs":{"bilibili":{"icon":"/svg/bilibili.svg","link":"https://b23.tv/MK4nKb"},"steam":{"icon":"/svg/steam.svg","link":"https://steamcommunity.com/id/cloudycity"}}}}}}