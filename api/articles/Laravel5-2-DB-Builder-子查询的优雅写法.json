{"title":"Laravel5.2 DB Builder 子查询的优雅写法","uid":"1d95107ced836961e9639f49026d155a","slug":"Laravel5-2-DB-Builder-子查询的优雅写法","date":"2019-02-25T03:42:38.000Z","updated":"2021-06-21T10:35:56.783Z","comments":true,"path":"api/articles/Laravel5-2-DB-Builder-子查询的优雅写法.json","cover":"https://cdn.educba.com/academy/wp-content/uploads/2020/05/Laravel-Query-Builder.jpg","content":"<p>Laravel5.2的DB Builder还没有<code>fromSub()</code>与<code>joinSub()</code>，Sql涉及子查询时，比较优雅的写法是利用<code>toSql()</code>与<code>mergeBindings()</code>。</p>\n<span id=\"more\"></span>\n\n<h3 id=\"From\"><a href=\"#From\" class=\"headerlink\" title=\"From\"></a>From</h3><pre class=\"line-numbers language-sql\" data-language=\"sql\"><code class=\"language-sql\"><span class=\"token keyword\">SELECT</span>\n\t<span class=\"token operator\">*</span>\n<span class=\"token keyword\">FROM</span>\n\t<span class=\"token punctuation\">(</span> <span class=\"token keyword\">SELECT</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">FROM</span> t1 <span class=\"token keyword\">WHERE</span> c1 <span class=\"token operator\">=</span> xxx <span class=\"token operator\">AND</span> c2 <span class=\"token operator\">=</span> xxx <span class=\"token keyword\">GROUP</span> <span class=\"token keyword\">BY</span> c1 <span class=\"token punctuation\">)</span> <span class=\"token keyword\">AS</span> sub \n<span class=\"token keyword\">WHERE</span>\n\tc1 <span class=\"token operator\">=</span> xxx \n\t<span class=\"token operator\">AND</span> c2 <span class=\"token operator\">=</span> xxx<span class=\"token punctuation\">;</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\"><span class=\"token variable\">$subQuery</span> <span class=\"token operator\">=</span> <span class=\"token class-name static-context\">DB</span><span class=\"token operator\">::</span><span class=\"token function\">table</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'t1'</span><span class=\"token punctuation\">)</span><span class=\"token operator\">-></span><span class=\"token function\">where</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'c1'</span><span class=\"token punctuation\">,</span> <span class=\"token string single-quoted-string\">'xxx'</span><span class=\"token punctuation\">)</span><span class=\"token operator\">-></span><span class=\"token function\">where</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'c2'</span><span class=\"token punctuation\">,</span> xxx<span class=\"token punctuation\">)</span><span class=\"token operator\">-></span><span class=\"token function\">groupBy</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'c1'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token variable\">$query</span> <span class=\"token operator\">=</span> <span class=\"token class-name static-context\">DB</span><span class=\"token operator\">::</span><span class=\"token function\">table</span><span class=\"token punctuation\">(</span><span class=\"token class-name static-context\">DB</span><span class=\"token operator\">::</span><span class=\"token function\">raw</span><span class=\"token punctuation\">(</span><span class=\"token string double-quoted-string\">\"(<span class=\"token interpolation\"><span class=\"token punctuation\">&#123;</span><span class=\"token variable\">$subQuery</span><span class=\"token operator\">-></span><span class=\"token function\">toSql</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#125;</span></span>) as sub\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    <span class=\"token operator\">-></span><span class=\"token function\">select</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'*'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n    <span class=\"token operator\">-></span><span class=\"token function\">where</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'c1'</span><span class=\"token punctuation\">,</span> <span class=\"token string single-quoted-string\">'xxx'</span><span class=\"token punctuation\">)</span>\n    <span class=\"token operator\">-></span><span class=\"token function\">where</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'c2'</span><span class=\"token punctuation\">,</span> <span class=\"token string single-quoted-string\">'xxx'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token operator\">-></span><span class=\"token function\">mergeBindings</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$subQuery</span><span class=\"token punctuation\">)</span>\n    <span class=\"token operator\">-></span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h3 id=\"Join\"><a href=\"#Join\" class=\"headerlink\" title=\"Join\"></a>Join</h3><pre class=\"line-numbers language-sql\" data-language=\"sql\"><code class=\"language-sql\"><span class=\"token keyword\">SELECT</span>\n\tt1<span class=\"token punctuation\">.</span><span class=\"token operator\">*</span><span class=\"token punctuation\">,</span>\n\tsub<span class=\"token punctuation\">.</span>c4 \n<span class=\"token keyword\">FROM</span>\n\tt1\n\t<span class=\"token keyword\">LEFT</span> <span class=\"token keyword\">JOIN</span> <span class=\"token punctuation\">(</span> <span class=\"token keyword\">SELECT</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">FROM</span> t2 <span class=\"token keyword\">GROUP</span> <span class=\"token keyword\">BY</span> c1<span class=\"token punctuation\">,</span> c2 <span class=\"token punctuation\">)</span> <span class=\"token keyword\">AS</span> sub <span class=\"token keyword\">ON</span> t1<span class=\"token punctuation\">.</span>c1 <span class=\"token operator\">=</span> t2<span class=\"token punctuation\">.</span>c1 \n\t<span class=\"token operator\">AND</span> t1<span class=\"token punctuation\">.</span>c2 <span class=\"token operator\">=</span> t2<span class=\"token punctuation\">.</span>c2<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\"><span class=\"token variable\">$subQuery</span> <span class=\"token operator\">=</span> <span class=\"token class-name static-context\">DB</span><span class=\"token operator\">::</span><span class=\"token function\">table</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'t2'</span><span class=\"token punctuation\">)</span><span class=\"token operator\">-></span><span class=\"token function\">groupBy</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'c1'</span><span class=\"token punctuation\">,</span> <span class=\"token string single-quoted-string\">'c2'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token variable\">$query</span> <span class=\"token operator\">=</span> <span class=\"token class-name static-context\">DB</span><span class=\"token operator\">::</span><span class=\"token function\">table</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'t1'</span><span class=\"token punctuation\">)</span>\n    <span class=\"token operator\">-></span><span class=\"token function\">select</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'t1.*'</span><span class=\"token punctuation\">,</span> <span class=\"token string single-quoted-string\">'sub.c4'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n    <span class=\"token operator\">-></span><span class=\"token function\">leftJoin</span><span class=\"token punctuation\">(</span><span class=\"token class-name static-context\">DB</span><span class=\"token operator\">::</span><span class=\"token function\">raw</span><span class=\"token punctuation\">(</span><span class=\"token string double-quoted-string\">\"(&#123;subQuery->toSql()&#125;) as sub\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token variable\">$join</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n        <span class=\"token comment\">/** @var JoinClause $join */</span>\n        <span class=\"token variable\">$join</span><span class=\"token operator\">-></span><span class=\"token function\">on</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'t1.c1'</span><span class=\"token punctuation\">,</span> <span class=\"token string single-quoted-string\">'='</span><span class=\"token punctuation\">,</span> <span class=\"token string single-quoted-string\">'t2.c1'</span><span class=\"token punctuation\">)</span>\n            <span class=\"token operator\">-></span><span class=\"token function\">on</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'t1.c2'</span><span class=\"token punctuation\">,</span> <span class=\"token string single-quoted-string\">'='</span><span class=\"token punctuation\">,</span> <span class=\"token string single-quoted-string\">'t2.c2'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span>\n    <span class=\"token operator\">-></span><span class=\"token function\">mergeBindings</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$subQuery</span><span class=\"token punctuation\">)</span>\n    <span class=\"token operator\">-></span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>","text":"Laravel5.2的DB Builder还没有fromSub()与joinSub()，Sql涉及子查询时，比较优雅的写法是利用toSql()与mergeBindings()。 FromSELECT * FROM ( SELECT * FROM t1 WHERE c1 = xxx...","link":"","photos":[],"count_time":{"symbolsCount":983,"symbolsTime":"1 mins."},"categories":[{"name":"php","slug":"php","count":13,"path":"api/categories/php.json"}],"tags":[{"name":"laravel","slug":"laravel","count":10,"path":"api/tags/laravel.json"}],"toc":"<ol class=\"toc\"><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#From\"><span class=\"toc-text\">From</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#Join\"><span class=\"toc-text\">Join</span></a></li></ol>","author":{"name":"CloudyCity","slug":"blog-author","avatar":"https://avatars.githubusercontent.com/u/17662451?s=400&u=643d94296b79c5e8424a2177fc4609a5e0ebeae0&v=4","link":"/","description":"拖延并发强迫症懒癌晚期患者","socials":{"github":"https://github.com/CloudyCity","twitter":"","stackoverflow":"https://stackoverflow.com/users/9827779/cloudycity","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"","juejin":"","customs":{"bilibili":{"icon":"/svg/bilibili.svg","link":"https://b23.tv/MK4nKb"},"steam":{"icon":"/svg/steam.svg","link":"https://steamcommunity.com/id/cloudycity"}}}},"mapped":true,"prev_post":{"title":"VSCode FTP与SSH插件推荐","uid":"53af487a07bcb20aa882173eb16518f3","slug":"VSCode-FTP与SSH插件推荐","date":"2019-02-28T08:13:43.000Z","updated":"2021-06-21T10:35:56.783Z","comments":true,"path":"api/articles/VSCode-FTP与SSH插件推荐.json","cover":"https://miro.medium.com/max/1200/1*YkgFq4CT5rRyz46K3uxHtQ.png","text":"因为一些不可抗力因素，我偶尔要直接在线上改文件，这时就要在几个工具间反复切换（xftp下载，sublime编辑，xftp上传，xshell执行），比较繁琐。最近刚好改用VSCode，在市场找到两个比较合适的插件，在一个编辑器内即可完成上述流程，非常顺滑。 SSH FS如果你直接在...","link":"","photos":[],"count_time":{"symbolsCount":357,"symbolsTime":"1 mins."},"categories":[{"name":"新手村","slug":"新手村","count":7,"path":"api/categories/新手村.json"}],"tags":[{"name":"工具","slug":"工具","count":1,"path":"api/tags/工具.json"}],"author":{"name":"CloudyCity","slug":"blog-author","avatar":"https://avatars.githubusercontent.com/u/17662451?s=400&u=643d94296b79c5e8424a2177fc4609a5e0ebeae0&v=4","link":"/","description":"拖延并发强迫症懒癌晚期患者","socials":{"github":"https://github.com/CloudyCity","twitter":"","stackoverflow":"https://stackoverflow.com/users/9827779/cloudycity","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"","juejin":"","customs":{"bilibili":{"icon":"/svg/bilibili.svg","link":"https://b23.tv/MK4nKb"},"steam":{"icon":"/svg/steam.svg","link":"https://steamcommunity.com/id/cloudycity"}}}}},"next_post":{"title":"hexo使用github issue存放文章与评论","uid":"f4794d5716996e12dfb018f0413b5642","slug":"hexo使用github-issue存放文章与评论","date":"2019-02-14T07:32:14.000Z","updated":"2021-06-21T10:35:56.784Z","comments":true,"path":"api/articles/hexo使用github-issue存放文章与评论.json","cover":"https://i.imgur.com/P2E0Xkw.jpg","text":"Hexo默认文章存放于source分支，没有评论系统，不过都可以通过插件进行扩展。本文介绍如何将hexo的文章与评论存放于Github Issue中（issue内容为博客内容，issue评论为博客评论）。 使用github issue存放文章这种方案主要优点是可以直接使用GitH...","link":"","photos":[],"count_time":{"symbolsCount":"1.9k","symbolsTime":"2 mins."},"categories":[{"name":"新手村","slug":"新手村","count":7,"path":"api/categories/新手村.json"}],"tags":[{"name":"hexo","slug":"hexo","count":5,"path":"api/tags/hexo.json"}],"author":{"name":"CloudyCity","slug":"blog-author","avatar":"https://avatars.githubusercontent.com/u/17662451?s=400&u=643d94296b79c5e8424a2177fc4609a5e0ebeae0&v=4","link":"/","description":"拖延并发强迫症懒癌晚期患者","socials":{"github":"https://github.com/CloudyCity","twitter":"","stackoverflow":"https://stackoverflow.com/users/9827779/cloudycity","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"","juejin":"","customs":{"bilibili":{"icon":"/svg/bilibili.svg","link":"https://b23.tv/MK4nKb"},"steam":{"icon":"/svg/steam.svg","link":"https://steamcommunity.com/id/cloudycity"}}}}}}